<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Premium cosmetic treatments at LUXE Beauty Salon. Secure online booking for luxury facials, microblading, laser hair removal and more.">
    <meta name="keywords" content="beauty salon, cosmetic treatments, facials, microblading, laser hair removal, luxury spa, online booking, profile management, admin dashboard">
    <title>LUXE Beauty | Premium Cosmetic Salon & Online Booking</title>

    <!-- Preload critical resources -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Montserrat:wght@300;400;500;600&display=swap" as="style" crossorigin="anonymous">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" as="style" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js" as="script" crossorigin="anonymous">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js" as="script" crossorigin="anonymous">


    <!-- Favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">

    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">

    <!-- CSS -->
    <style>
        :root {
            /* Color Scheme */
            --deep-navy: #0a1a3a;
            --gold-accent: #d4af37; /* Main Gold */
            --soft-beige: #f5f0e6;
            --light-gold: #f8f3e6; /* Lighter background */
            --dark-gold: #b89b2e; /* Hover Gold */
            --soft-white: #ffffff;
            --light-gray: #f8f9fa; /* Disabled states */
            --medium-gray: #e9ecef; /* Borders */
            --text-dark: #333333;
            --text-muted: #6c757d;
            --error-red: #dc3545;
            --success-green: #28a745;
            --info-blue: #17a2b8;

            /* Shadows */
            --shadow-sm: 0 2px 8px rgba(10, 26, 58, 0.08);
            --shadow-md: 0 4px 16px rgba(10, 26, 58, 0.12);
            --shadow-lg: 0 8px 30px rgba(10, 26, 58, 0.18);

            /* Transitions */
            --transition-fast: all 0.2s ease-in-out;
            --transition-med: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --transition-slow: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
            --transition-transform: transform 0.15s ease-out;


            /* Spacing & Borders */
            --section-padding: 5rem 0;
            --container-padding: 0 1.5rem;
            --border-radius-sm: 4px;
            --border-radius-md: 8px;
            --border-radius-lg: 12px;
            --border-radius-xl: 20px;
            --border-radius-round: 50px;
        }

        /* Base Styles */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; font-size: 16px; }
        body { font-family: 'Montserrat', sans-serif; color: var(--text-dark); background-color: var(--soft-white); line-height: 1.6; overflow-x: hidden; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        body.modal-open { overflow: hidden; padding-right: 15px; /* Adjust based on scrollbar width */ }
        h1, h2, h3, h4, h5, h6 { font-family: 'Playfair Display', serif; font-weight: 600; color: var(--deep-navy); line-height: 1.3; margin-bottom: 0.75em; }
        a { text-decoration: none; color: var(--gold-accent); transition: var(--transition-fast); }
        a:hover { color: var(--dark-gold); }
        button, input, textarea, select { font-family: inherit; font-size: inherit; border: none; outline: none; appearance: none; -webkit-appearance: none; }
        img { max-width: 100%; height: auto; display: block; }
        ul { list-style: none; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--deep-navy); font-size: 0.9rem; }

        /* Typography & Layout */
        .text-lead { font-size: 1.2rem; opacity: 0.9; margin-bottom: 1.5rem; }
        .text-muted { color: var(--text-muted); }
        .text-center { text-align: center; }
        .visually-hidden { position: absolute; width: 1px; height: 1px; margin: -1px; padding: 0; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0; }
        .container { width: 100%; max-width: 1400px; margin: 0 auto; padding: var(--container-padding); }
        .section { padding: var(--section-padding); position: relative; }
        .section-title { text-align: center; margin-bottom: 4rem; position: relative; }
        .section-title h2 { font-size: 2.5rem; display: inline-block; position: relative; padding-bottom: 1rem; }
        .section-title h2::after { content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 80px; height: 3px; background: var(--gold-accent); border-radius: 2px; }
        .section-title p.text-muted { font-size: 1.1rem; max-width: 650px; margin: 0.5rem auto 0; }

        /* Buttons */
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.8rem 1.8rem; border-radius: var(--border-radius-round); font-weight: 600; cursor: pointer; transition: var(--transition-med); gap: 0.6rem; text-align: center; white-space: nowrap; border: 2px solid transparent; font-size: 0.95rem; letter-spacing: 0.5px; text-transform: uppercase; position: relative; }
        .btn-primary { background-color: var(--gold-accent); color: var(--deep-navy); box-shadow: var(--shadow-sm); border-color: var(--gold-accent); }
        .btn-primary:hover { background-color: var(--dark-gold); border-color: var(--dark-gold); transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .btn-outline { background-color: transparent; color: var(--deep-navy); border-color: var(--deep-navy); }
        .btn-outline:hover { background-color: rgba(10, 26, 58, 0.05); transform: translateY(-2px); }
        .btn-outline-white { background-color: transparent; color: var(--soft-white); border-color: var(--soft-white); }
        .btn-outline-white:hover { background-color: rgba(255, 255, 255, 0.1); transform: translateY(-2px); }
        .btn-dark { background-color: var(--deep-navy); color: var(--soft-white); }
        .btn-dark:hover { background-color: #0c214b; transform: translateY(-2px); }
        .btn-block { display: flex; width: 100%; }
        .btn .spinner { display: none; width: 18px; height: 18px; border: 2px solid rgba(10, 26, 58, 0.2); border-top-color: var(--deep-navy); border-radius: 50%; animation: spin 0.8s linear infinite; }
        .btn.loading .btn-text { opacity: 0; }
        .btn.loading .spinner { display: block; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); }
        .btn:disabled, .btn.loading { cursor: not-allowed; background-color: var(--medium-gray); border-color: var(--medium-gray); color: var(--text-muted); box-shadow: none; transform: none; opacity: 0.7; }
        .btn:disabled:hover { background-color: var(--medium-gray); transform: none; }
        .submit-btn { width: 100%; padding: 1rem; background-color: var(--gold-accent); color: var(--deep-navy); border: none; border-radius: var(--border-radius-md); font-weight: 600; font-size: 1.1rem; cursor: pointer; transition: var(--transition-med); margin-top: 1rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .submit-btn:hover { background-color: var(--dark-gold); }
        .submit-btn:disabled, .submit-btn.loading { background-color: var(--medium-gray); border-color: var(--medium-gray); cursor: not-allowed; color: var(--text-muted); opacity: 1;}
        .submit-btn .spinner { border-top-color: var(--deep-navy); }


        /* Navigation */
        nav { position: fixed; top: 0; left: 0; width: 100%; background-color: var(--deep-navy); box-shadow: var(--shadow-md); z-index: 1000; transition: var(--transition-med); padding: 1rem 0; }
        .nav-container { display: flex; justify-content: space-between; align-items: center; max-width: 1400px; margin: 0 auto; padding: var(--container-padding); }
        .logo { font-family: 'Playfair Display', serif; font-size: 1.8rem; font-weight: 700; color: var(--soft-white); display: flex; align-items: center; }
        .logo span { color: var(--gold-accent); margin-left: 0.5rem; }
        .nav-links { display: flex; gap: 2.5rem; }
        .nav-links a { color: var(--soft-white); font-weight: 500; position: relative; padding: 0.5rem 0; font-size: 0.95rem; }
        .nav-links a::after { content: ''; position: absolute; bottom: 0; left: 0; width: 0; height: 2px; background-color: var(--gold-accent); transition: var(--transition-fast); }
        .nav-links a:hover::after, .nav-links a.active::after { width: 100%; }
        .nav-links a:hover, .nav-links a.active { color: var(--gold-accent); }
        .auth-buttons { display: flex; gap: 1rem; }

        /* Mobile Menu */
        .burger-menu { display: none; cursor: pointer; width: 30px; height: 20px; position: relative; z-index: 1001; flex-direction: column; justify-content: space-between; }
        .burger-menu span { display: block; height: 2px; width: 100%; background: var(--soft-white); border-radius: 2px; transition: var(--transition-med); position: absolute; left: 0; }
        .burger-menu span:nth-child(1) { top: 0; }
        .burger-menu span:nth-child(2) { top: 50%; transform: translateY(-50%); }
        .burger-menu span:nth-child(3) { top: 50%; transform: translateY(-50%); }
        .burger-menu span:nth-child(4) { bottom: 0; }
        .burger-menu.open span:nth-child(1) { top: 50%; transform: translateY(-50%) rotate(45deg); }
        .burger-menu.open span:nth-child(4) { bottom: 50%; transform: translateY(50%) rotate(-45deg); }
        .burger-menu.open span:nth-child(2), .burger-menu.open span:nth-child(3) { opacity: 0; }
        .nav-links.mobile-active { display: flex; flex-direction: column; position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background-color: var(--deep-navy); padding: 8rem 2rem 2rem; z-index: 1000; gap: 2rem; align-items: center; transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); }
        .nav-links.mobile-active.open { transform: translateX(0); }


        /* Hero Section */
        .hero { min-height: 90vh; background: linear-gradient(rgba(10, 26, 58, 0.75), rgba(10, 26, 58, 0.75)), url('https://images.unsplash.com/photo-1522335789203-aabd1fc54bc9?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1887&q=80') center/cover no-repeat fixed; display: flex; align-items: center; color: var(--soft-white); position: relative; overflow: hidden; padding-top: 80px; }
        .hero::before { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 100px; background: linear-gradient(to top, var(--soft-white), transparent); z-index: 1; }
        .hero-content { max-width: 800px; margin: 0 auto; text-align: center; position: relative; z-index: 2; padding: 0 2rem; opacity: 0; transform: translateY(30px); animation: fadeInUp 1s ease forwards 0.3s; }
        .hero h1 { font-size: 3.8rem; margin-bottom: 1.5rem; color: var(--soft-white); }
        .hero p.text-lead { font-size: 1.3rem; margin-bottom: 2.5rem; opacity: 0.9; }
        .hero .btn { font-size: 1.1rem; padding: 1rem 2.5rem; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

        /* Services Section */
        .services-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 2.5rem; margin-top: 3rem; }
        .service-card { background: var(--soft-white); border-radius: var(--border-radius-lg); overflow: hidden; box-shadow: var(--shadow-md); transition: var(--transition-med); position: relative; }
        .service-card:hover { transform: translateY(-10px); box-shadow: var(--shadow-lg); }
        .service-img { height: 250px; overflow: hidden; }
        .service-img img { width: 100%; height: 100%; object-fit: cover; transition: var(--transition-slow); }
        .service-card:hover .service-img img { transform: scale(1.05); }
        .service-info { padding: 1.5rem 1.8rem; }
        .service-info h3 { font-size: 1.5rem; margin-bottom: 0.75rem; }
        .service-info p { color: var(--text-muted); margin-bottom: 1.5rem; font-size: 0.95rem; }
        .service-price { display: flex; justify-content: space-between; align-items: center; }
        .price { font-size: 1.3rem; font-weight: 600; color: var(--gold-accent); }
        .book-btn { background-color: var(--deep-navy); color: var(--soft-white); padding: 0.6rem 1.4rem; border-radius: var(--border-radius-round); font-weight: 500; cursor: pointer; transition: var(--transition-fast); display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; border: 1px solid var(--deep-navy); }
        .book-btn:hover { background-color: var(--gold-accent); color: var(--deep-navy); border-color: var(--gold-accent); }
        .book-btn i { font-size: 0.9em; }

        /* Booking Section (Main Calendar Area) */
        .booking-container {
            background-color: var(--soft-white);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            padding: 1.5rem;
            position: relative;
            min-height: 550px;
            margin-top: 2rem;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
            overflow: hidden;
        }
        @media (min-width: 768px) { .booking-container { padding: 2rem; } }

        .calendar-loader {
            position: absolute; inset: 0; background-color: rgba(255, 255, 255, 0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10; border-radius: var(--border-radius-lg); opacity: 1; visibility: visible; transition: opacity 0.4s ease-out, visibility 0.4s ease-out; pointer-events: none;
        }
        .calendar-loader.hidden { opacity: 0; visibility: hidden; }
        .calendar-loader .spinner { width: 45px; height: 45px; border: 4px solid rgba(212, 175, 55, 0.2); border-top-color: var(--gold-accent); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 1rem; }
        .calendar-loader p { font-weight: 500; color: var(--text-muted); }

        #main-calendar {
            opacity: 0;
            min-height: 500px;
            animation-duration: 0.6s;
            animation-fill-mode: forwards;
            animation-timing-function: ease-out;
        }
        #main-calendar.loaded {
            opacity: 1;
            animation-name: fadeInCalendar;
        }
        @keyframes fadeInCalendar {
            from { opacity: 0; transform: translateY(15px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        #calendar-message-area { margin-top: 1rem; min-height: 40px; }


        /* FullCalendar v6 Customization (Enhanced) */
        :root {
            --fc-border-color: var(--medium-gray);
            --fc-today-bg-color: rgba(212, 175, 55, 0.08);
            --fc-event-bg-color: var(--gold-accent);
            --fc-event-border-color: var(--gold-accent);
            --fc-event-text-color: var(--deep-navy);
            --fc-button-bg-color: var(--deep-navy);
            --fc-button-text-color: var(--soft-white);
            --fc-button-border-color: var(--deep-navy);
            --fc-button-hover-bg-color: var(--dark-gold);
            --fc-button-hover-border-color: var(--dark-gold);
            --fc-button-hover-text-color: var(--deep-navy);
            --fc-button-active-bg-color: var(--dark-gold);
            --fc-button-active-border-color: var(--dark-gold);
            --fc-list-event-hover-bg-color: var(--light-gold);
        }
        .fc { font-family: 'Montserrat', sans-serif; font-size: 0.95rem; }
        .fc .fc-toolbar.fc-header-toolbar { margin-bottom: 1.5rem; padding: 0.5rem 0; }
        .fc .fc-toolbar-title { font-size: 1.6rem; font-weight: 600; color: var(--deep-navy); font-family: 'Playfair Display', serif; }
        .fc .fc-button { text-transform: capitalize; border-radius: var(--border-radius-round); padding: 0.5em 1.2em; font-weight: 500; box-shadow: none; transition: var(--transition-fast) !important; }
        .fc .fc-button:focus { box-shadow: 0 0 0 3px rgba(10, 26, 58, 0.2); }
        .fc .fc-daygrid-day-number { font-weight: 500; color: var(--text-dark); padding: 0.6em; position: relative; z-index: 1; }
        .fc .fc-daygrid-day.fc-day-today { border-top: 3px solid var(--gold-accent); background-color: var(--fc-today-bg-color) !important; }
        .fc .fc-daygrid-day.fc-day-today .fc-daygrid-day-number { font-weight: 700; color: var(--gold-accent); }
        .fc .fc-day-past { background-color: var(--light-gray) !important; cursor: not-allowed; }
        .fc .fc-day-past .fc-daygrid-day-number { color: var(--text-muted); }
        .fc .fc-daygrid-day:not(.fc-day-past):not(.fc-day-disabled):not(.fc-day-full):not(.fc-day-today) {
             cursor: pointer; transition: background-color var(--transition-fast), transform var(--transition-transform); position: relative;
        }
        .fc .fc-daygrid-day:not(.fc-day-past):not(.fc-day-disabled):not(.fc-day-full):not(.fc-day-today):hover {
             background-color: rgba(10, 26, 58, 0.08) !important;
             transform: scale(1.02);
             z-index: 2;
        }
        .fc .fc-daygrid-day.fc-day-today:not(.fc-day-past):not(.fc-day-disabled):not(.fc-day-full):hover {
            background-color: rgba(212, 175, 55, 0.15) !important;
            transform: scale(1.02);
            z-index: 2;
        }
        .fc-day-limited { background-color: rgba(255, 193, 7, 0.1) !important; }
        .fc-day-limited:hover { background-color: rgba(255, 193, 7, 0.2) !important; transform: scale(1.02); }
        .fc-day-full { background-color: rgba(220, 53, 69, 0.05) !important; cursor: not-allowed !important; }
        .fc-day-full .fc-daygrid-day-number { color: var(--text-muted); }
        .fc-day-full:hover { background-color: rgba(220, 53, 69, 0.05) !important; transform: none; }
        .fc-day.selected-date {
             background-color: rgba(212, 175, 55, 0.3) !important;
             transform: scale(1.01);
             box-shadow: 0 0 0 2px var(--dark-gold) inset;
             z-index: 3;
        }
        .fc th.fc-col-header-cell { font-weight: 600; color: var(--deep-navy); text-transform: uppercase; font-size: 0.8rem; border-bottom-width: 1px; padding-bottom: 0.8em; }
        .fc .fc-event { border: none; padding: 0.25rem 0.5rem; border-radius: var(--border-radius-sm); font-size: 0.85rem; font-weight: 500; cursor: pointer; transition: var(--transition-fast); }
        .fc .fc-event:hover { filter: brightness(1.1); }
        .fc .fc-daygrid-event-dot { border-color: var(--deep-navy); }
        .fc .fc-list-event-dot { border-color: var(--gold-accent); }
        .fc .fc-list-event-title a { color: var(--deep-navy); font-weight: 500; }
        .fc .fc-list-event-time { color: var(--text-muted); }


        /* Products Section */
        .product-viewer { display: flex; flex-direction: column; align-items: center; margin-top: 3rem; }
        .product-3d-container { width: 300px; height: 300px; perspective: 1000px; margin-bottom: 2rem; cursor: grab; }
        .product-3d-container:active { cursor: grabbing; }
        .product-3d { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.1s linear; }
        .product-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; justify-content: center; align-items: center; background-color: var(--light-gold); border-radius: 10px; box-shadow: inset 0 0 10px rgba(0,0,0,0.1); border: 1px solid var(--medium-gray); }
        .product-face img { max-width: 75%; max-height: 75%; object-fit: contain; user-select: none; -webkit-user-drag: none; }
        .product-face.front  { transform: translateZ(50px); }
        .product-face.back   { transform: rotateY(180deg) translateZ(50px); background-image: url('https://via.placeholder.com/200x250/F8F3E6/0A1A3A?text=Ingredients'); background-size: cover; }
        .product-controls { display: flex; flex-wrap: wrap; gap: 0.75rem; justify-content: center; margin-bottom: 2rem; }
        .product-controls .btn { padding: 0.6rem 1.2rem; font-size: 0.9rem; }
        .product-controls .btn i { font-size: 1.1em; }


        /* Modals */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(10, 26, 58, 0.85); display: flex; justify-content: center; align-items: center; z-index: 2000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0s linear 0.3s; backdrop-filter: blur(4px); padding: 1rem; }
        .modal.active { opacity: 1; visibility: visible; transition-delay: 0s; }
        .modal-content { background-color: var(--soft-white); border-radius: var(--border-radius-lg); width: 100%; max-width: 550px; box-shadow: var(--shadow-lg); transform: scale(0.95) translateY(10px); transition: transform 0.3s ease, opacity 0.3s ease; opacity: 0; max-height: 90vh; display: flex; flex-direction: column; overflow: hidden; }
        .modal.active .modal-content { transform: scale(1) translateY(0); opacity: 1; }
        .modal-header { background-color: var(--deep-navy); color: var(--soft-white); padding: 1.25rem 1.5rem; border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .modal-header h3 { font-size: 1.5rem; margin: 0; color: var(--soft-white); }
        .close-modal { background: none; border: none; color: var(--soft-white); font-size: 1.8rem; cursor: pointer; transition: var(--transition-fast); width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; line-height: 1; padding: 0; }
        .close-modal:hover { background-color: rgba(255, 255, 255, 0.1); transform: rotate(90deg); }
        .modal-body { padding: 2rem 1.5rem; overflow-y: auto; flex-grow: 1; }
         @media (min-width: 768px) { .modal-body { padding: 2.5rem; } }
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--deep-navy); font-size: 0.9rem; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.8rem 1rem; border: 1px solid var(--medium-gray); border-radius: var(--border-radius-md); font-size: 1rem; transition: var(--transition-fast); background-color: var(--soft-white); color: var(--text-dark); }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: var(--gold-accent); box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2); }
        .form-group input[readonly], .form-group select[disabled] { background-color: var(--light-gray); cursor: not-allowed; opacity: 0.7; }
        .form-group input.error, .form-group select.error, .form-group textarea.error { border-color: var(--error-red); } /* Add error border */
        .form-group input.error:focus, .form-group select.error:focus, .form-group textarea.error:focus { box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.25); } /* Red focus glow */
        .form-group select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 1rem center; background-size: 16px 12px; padding-right: 2.5rem; }
        .form-group textarea { resize: vertical; min-height: 100px; }
        .switch-modal-link { text-align: center; margin-top: 1.5rem; color: var(--text-muted); font-size: 0.9rem; }
        .switch-modal-link a { color: var(--deep-navy); font-weight: 600; text-decoration: none; transition: var(--transition-fast); cursor: pointer; }
        .switch-modal-link a:hover { color: var(--gold-accent); text-decoration: underline; }
        .error-message { color: var(--error-red); font-size: 0.85rem; margin-top: 0.3rem; display: none; }
        #booking-login-prompt { background-color: rgba(212, 175, 55, 0.1); padding: 1rem; border-radius: var(--border-radius-md); margin-bottom: 1.5rem; text-align: center; color: var(--deep-navy); display: none; font-size: 0.95rem; }
        #booking-login-prompt a { color: var(--deep-navy); font-weight: 600; text-decoration: underline; cursor: pointer; }
        #booking-login-prompt a:hover { color: var(--gold-accent); }
        .time-slots-container { position: relative; min-height: 50px; margin-top: 0.5rem; }
        .time-slots-loader { position: absolute; top: 0px; left: 0; width: 100%; display: flex; justify-content: center; align-items: center; opacity: 0; transition: var(--transition-fast); visibility: hidden; background: rgba(255,255,255,0.7); padding: 5px 0; border-radius: var(--border-radius-md); }
        .time-slots-loader.visible { opacity: 1; visibility: visible; }
        .time-slots-loader .spinner-sm { width: 24px; height: 24px; border-width: 3px; }
        .time-slots-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(95px, 1fr)); gap: 0.75rem; }
        .time-slot-btn { padding: 0.6rem 0.5rem; border: 1px solid var(--medium-gray); border-radius: var(--border-radius-md); background-color: var(--soft-white); color: var(--deep-navy); cursor: pointer; transition: var(--transition-fast); font-weight: 500; text-align: center; font-size: 0.9rem; }
        .time-slot-btn:hover:not(:disabled) { border-color: var(--gold-accent); background-color: var(--light-gold); }
        .time-slot-btn.selected { background-color: var(--deep-navy); color: var(--soft-white); border-color: var(--deep-navy); font-weight: 600; }
        .time-slot-btn:disabled { background-color: var(--light-gray); color: var(--text-muted); border-color: var(--medium-gray); cursor: not-allowed; opacity: 0.6; }
        .no-slots-message { color: var(--text-muted); font-style: italic; text-align: center; padding: 1rem 0; font-size: 0.9rem; }
         #modal-alert-area { margin-top: 1.5rem; margin-bottom: -0.5rem; }


        /* Profile & Admin Section Common */
        .user-section { display: none; padding: var(--section-padding); padding-top: calc(var(--section-padding) + 60px); background-color: var(--light-gold); min-height: 80vh; }
        .user-container { display: grid; grid-template-columns: 280px 1fr; gap: 2.5rem; max-width: 1400px; margin: 0 auto; padding: 0 var(--container-padding); }
        .user-sidebar { background-color: var(--soft-white); border-radius: var(--border-radius-lg); padding: 2rem; box-shadow: var(--shadow-sm); height: fit-content; position: sticky; top: 100px; }
        .user-header { text-align: center; margin-bottom: 2rem; border-bottom: 1px solid var(--medium-gray); padding-bottom: 1.5rem; }
        .user-pic { width: 90px; height: 90px; border-radius: 50%; background-color: var(--gold-accent); color: var(--deep-navy); display: flex; align-items: center; justify-content: center; font-size: 2.5rem; font-weight: 600; margin: 0 auto 1rem; border: 3px solid var(--soft-white); box-shadow: var(--shadow-sm); }
        .user-name { font-size: 1.4rem; margin-bottom: 0.3rem; word-break: break-word; }
        .user-meta { color: var(--text-muted); font-size: 0.85rem; }
        .user-menu { list-style: none; margin-top: 1rem; }
        .user-menu li { margin-bottom: 0.5rem; }
        .user-menu a { display: flex; align-items: center; gap: 0.8rem; padding: 0.8rem 1rem; border-radius: var(--border-radius-md); color: var(--text-dark); transition: var(--transition-fast); cursor: pointer; font-weight: 500; font-size: 0.95rem; }
        .user-menu a i { width: 20px; text-align: center; color: var(--text-muted); transition: var(--transition-fast); }
        .user-menu a:hover { background-color: rgba(10, 26, 58, 0.05); color: var(--deep-navy); }
        .user-menu a:hover i { color: var(--deep-navy); }
        .user-menu a.active { background-color: var(--gold-accent); color: var(--deep-navy); font-weight: 600; }
        .user-menu a.active i { color: var(--deep-navy); }
        .user-content { background-color: var(--soft-white); border-radius: var(--border-radius-lg); padding: 2rem 2.5rem; box-shadow: var(--shadow-md); }
        .user-content-tab { display: none; animation: fadeIn 0.5s ease; }
        .user-content-tab.active { display: block; }
        .user-content h2 { margin-bottom: 2rem; font-size: 1.8rem; border-bottom: 1px solid var(--medium-gray); padding-bottom: 0.8rem; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Profile Section Specific */
        #profile-appointments-content .appointments-calendar-container { height: 600px; margin-top: 1.5rem; background: #fff; padding: 1rem; border-radius: var(--border-radius-md); border: 1px solid var(--medium-gray); }
        #profile-history-content ul, #profile-favorites-content ul { padding-left: 0; }
        #profile-history-content li, #profile-favorites-content li { margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--medium-gray); list-style-type: none; }
        #profile-history-content li:last-child, #profile-favorites-content li:last-child { border-bottom: none; margin-bottom: 0; }
        #profile-favorites-content li { display: flex; justify-content: space-between; align-items: center; }
        #profile-favorites-content .book-btn { padding: 0.4rem 1rem; font-size: 0.85rem; }
        #profile-profile-info-content .form-group input[readonly] { background-color: var(--light-gray); cursor: default; }


        /* Admin Section Specific */
        .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; grid-column: 1 / -1; padding: 0 var(--container-padding); }
        .admin-header h2 { margin-bottom: 0; font-size: 2rem; }
        #admin .user-content h2 { margin-bottom: 2rem; font-size: 1.8rem; }
        .admin-main-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 2rem; }
        .stats-card { background-color: var(--soft-white); border-radius: var(--border-radius-lg); padding: 1.5rem; box-shadow: var(--shadow-sm); border: 1px solid var(--medium-gray); }
        .stats-card h3 { font-size: 1.15rem; margin-bottom: 1.5rem; font-weight: 500; color: var(--text-muted); border-bottom: 1px solid var(--medium-gray); padding-bottom: 0.5rem; }
        .chart-container { height: 250px; position: relative; }
        .admin-calendar-container { height: 700px; margin-top: 1.5rem; background: #fff; padding: 1rem; border-radius: var(--border-radius-md); border: 1px solid var(--medium-gray); }
        .placeholder-content { background-color: var(--light-gold); padding: 3rem 2rem; border-radius: var(--border-radius-lg); text-align: center; border: 1px dashed var(--medium-gray); margin-top: 1rem; }
        .placeholder-content i { color: var(--gold-accent); margin-bottom: 1rem; opacity: 0.8; }
        .placeholder-content p { color: var(--text-muted); font-size: 1.1rem; }


        /* Footer */
        footer { background-color: var(--deep-navy); color: rgba(255, 255, 255, 0.8); padding: 4rem 0 2rem; margin-top: auto; }
        .footer-content { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 3rem; max-width: 1400px; margin: 0 auto; padding: 0 var(--container-padding); }
        .footer-column h3 { color: var(--soft-white); font-size: 1.5rem; margin-bottom: 1.5rem; position: relative; padding-bottom: 0.75rem; font-weight: 500; }
        .footer-column h3::after { content: ''; position: absolute; bottom: 0; left: 0; width: 50px; height: 2px; background-color: var(--gold-accent); }
        .footer-column p { margin-bottom: 1.5rem; opacity: 0.8; font-size: 0.95rem; line-height: 1.7; }
        .social-links { display: flex; gap: 1rem; }
        .social-links a { display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; border-radius: 50%; background-color: rgba(255, 255, 255, 0.1); color: var(--soft-white); transition: var(--transition-fast); font-size: 1.1rem; }
        .social-links a:hover { background-color: var(--gold-accent); color: var(--deep-navy); transform: scale(1.1); }
        .footer-column ul { list-style: none; padding-left: 0; }
        .footer-column ul li { margin-bottom: 0.9rem; }
        .footer-column ul li a { color: inherit; opacity: 0.8; transition: var(--transition-fast); display: flex; align-items: center; gap: 0.75rem; font-size: 0.95rem; text-decoration: none; }
        .footer-column ul li a:hover { opacity: 1; color: var(--gold-accent); padding-left: 5px; }
        .footer-column ul li i { width: 20px; text-align: center; }
        .copyright { text-align: center; margin-top: 4rem; padding-top: 2rem; border-top: 1px solid rgba(255, 255, 255, 0.1); opacity: 0.7; font-size: 0.9rem; }
        @keyframes spin { to { transform: rotate(360deg); } }

         /* Alert Styles */
         .alert { padding: 1rem 1.25rem; margin-bottom: 1rem; border: 1px solid transparent; border-radius: var(--border-radius-md); font-size: 0.95rem; display: flex; align-items: center; gap: 0.75rem; opacity: 0; transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out, max-height 0.3s ease-in-out, margin 0.3s ease-in-out; transform: translateY(-10px); max-height: 0; overflow: hidden; }
         .alert.visible { opacity: 1; transform: translateY(0); max-height: 100px; /* Adjust as needed */ margin-top: 1rem; margin-bottom: 1rem; }
         .alert-icon { font-size: 1.2rem; line-height: 1; }
         .alert-danger { color: #721c24; background-color: #f8d7da; border-color: #f5c6cb; }
         .alert-danger .alert-icon { color: var(--error-red); }
         .alert-success { color: #155724; background-color: #d4edda; border-color: #c3e6cb; }
         .alert-success .alert-icon { color: var(--success-green); }
         .alert-info { color: #0c5460; background-color: #d1ecf1; border-color: #bee5eb; }
         .alert-info .alert-icon { color: var(--info-blue); }
         .alert p { margin-bottom: 0; line-height: 1.4; }
         .alert strong { font-weight: 600; }


        /* Responsive Styles */
        @media (max-width: 1200px) {
            .user-container { grid-template-columns: 240px 1fr; gap: 2rem; }
        }
        @media (max-width: 992px) {
            .nav-links { display: none; }
            .burger-menu { display: flex; }
            .nav-links.mobile-active { display: flex; }
             .hero h1 { font-size: 3rem; }
             .user-container { grid-template-columns: 1fr; }
             .user-sidebar { position: static; margin-bottom: 2rem; }
             .admin-header { grid-column: auto; }
             .section { padding: 4rem 0; }
        }
        @media (max-width: 768px) {
             :root { --section-padding: 3.5rem 0; }
             html { font-size: 15px; }
             .hero { min-height: 70vh; }
             .hero h1 { font-size: 2.5rem; }
             .hero p.text-lead { font-size: 1.1rem; }
             .services-grid { grid-template-columns: 1fr; }
             .modal-content { max-width: 95%; }
             .section-title h2 { font-size: 2rem; }
             .user-content { padding: 1.5rem; }
             .footer-content { gap: 2rem; }
             .admin-main-grid { grid-template-columns: 1fr; }
        }
        @media (max-width: 576px) {
             body.modal-open { padding-right: 0; }
             .container { padding: 0 1rem; }
             .hero h1 { font-size: 2.1rem; }
             .hero .btn { padding: 0.8rem 1.8rem; font-size: 0.9rem; }
             .btn { padding: 0.7rem 1.5rem; font-size: 0.9rem; }
             .auth-buttons { gap: 0.5rem; }
             .footer-content { grid-template-columns: 1fr; text-align: center; }
              .footer-column h3::after { left: 50%; transform: translateX(-50%); }
              .social-links { justify-content: center; }
             .nav-container { padding: 0 1rem; }
             .modal-body { padding: 1.5rem 1rem; }
             .user-sidebar { padding: 1.5rem; }
             .user-content { padding: 1.5rem 1rem; }
             .time-slots-grid { grid-template-columns: repeat(auto-fit, minmax(85px, 1fr)); gap: 0.5rem; }
             .time-slot-btn { font-size: 0.85rem; padding: 0.5rem 0.4rem; }
        }

    </style>
</head>
<body>
    <!-- Navigation -->
    <nav id="main-nav">
        <div class="nav-container container">
            <a href="#home" class="logo">LUXE<span>Beauty</span></a>

            <ul class="nav-links" id="nav-links">
                 <li><a href="#home" data-section="home" class="active">Home</a></li>
                 <li><a href="#services" data-section="services">Services</a></li>
                 <li><a href="#booking" data-section="booking">Booking</a></li>
                 <li><a href="#products" data-section="products">Products</a></li>
                 <li><a href="#profile" id="profile-link" data-section="profile">My Profile</a></li>
                 <li><a href="#admin" id="admin-link" data-section="admin" style="display: none;">Admin</a></li>
            </ul>

            <div class="auth-buttons">
                <button class="btn btn-outline-white" id="login-btn">Login</button>
                <button class="btn btn-primary" id="signup-btn">Sign Up</button>
                <button class="btn btn-outline-white" id="logout-btn" style="display: none;">Logout</button>
            </div>

             <div class="burger-menu" id="burger-menu">
                <span></span><span></span><span></span><span></span>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main id="main-content">
        <!-- Hero Section -->
        <section class="hero section" id="home">
            <div class="hero-content">
                <h1>Reveal Your Natural Beauty</h1>
                <p class="text-lead">Experience premium cosmetic treatments in our luxurious salon with expert care and personalized service.</p>
                <a href="#booking" class="btn btn-primary">Book Now</a>
            </div>
        </section>

        <!-- Services Section -->
        <section class="section" id="services">
            <div class="container">
                <div class="section-title">
                    <h2>Our Services</h2>
                    <p class="text-muted">Premium treatments tailored to your unique beauty needs</p>
                </div>
                <div class="services-grid">
                     <div class="service-card" data-service-id="signature-facial" data-service-name="Signature Facial" data-price="120">
                        <div class="service-img">
                            <img src="https://images.unsplash.com/photo-1522337360788-8b13dee7a37e?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=730&q=80" alt="Signature Facial" loading="lazy">
                        </div>
                        <div class="service-info">
                            <h3>Signature Facial</h3>
                            <p>Deep cleansing, exfoliation, and hydration for radiant skin.</p>
                            <div class="service-price">
                                <span class="price">$120</span>
                                <button class="book-btn">
                                    <i class="far fa-calendar-alt"></i> Book Now
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="service-card" data-service-id="microblading" data-service-name="Microblading" data-price="350">
                        <div class="service-img">
                            <img src="https://images.unsplash.com/photo-1595476108010-b4d1f102b1b1?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=688&q=80" alt="Microblading" loading="lazy">
                        </div>
                        <div class="service-info">
                            <h3>Microblading</h3>
                            <p>Natural-looking semi-permanent brows that enhance your features.</p>
                            <div class="service-price">
                                <span class="price">$350</span>
                                <button class="book-btn">
                                    <i class="far fa-calendar-alt"></i> Book Now
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="service-card" data-service-id="laser-hair" data-service-name="Laser Hair Removal" data-price="250">
                        <div class="service-img">
                            <img src="https://images.unsplash.com/photo-1599351431402-3e0e13cf1430?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=735&q=80" alt="Laser Hair Removal" loading="lazy">
                        </div>
                        <div class="service-info">
                            <h3>Laser Hair Removal</h3>
                            <p>Effective reduction of unwanted hair with minimal discomfort.</p>
                            <div class="service-price">
                                <span class="price">$250/session</span>
                                <button class="book-btn">
                                    <i class="far fa-calendar-alt"></i> Book Now
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Booking Section (Main Calendar Display) -->
        <section class="section" id="booking">
            <div class="container">
                 <div class="section-title">
                    <h2>Book Your Appointment</h2>
                    <p class="text-muted">Select an available date on the calendar below to open the booking form and choose your service and time.</p>
                 </div>
                 <div class="booking-container">
                    <div class="calendar-loader" id="calendar-loader">
                        <div class="spinner"></div>
                        <p>Loading Calendar...</p>
                    </div>
                    <div id="main-calendar"></div>
                    <div id="calendar-message-area"></div>
                </div>
            </div>
        </section>

        <!-- Products Section -->
        <section class="section" id="products">
            <div class="container">
                <div class="section-title">
                    <h2>Our Premium Products</h2>
                    <p class="text-muted">Luxury skincare formulated with the finest ingredients</p>
                </div>
                <div class="product-viewer">
                    <div class="product-3d-container" title="Click and drag to rotate">
                        <div class="product-3d" id="product-3d">
                             <div class="product-face front">
                                <img src="https://via.placeholder.com/240x300/F8F3E6/0A1A3A?text=LUXE+Serum" alt="LUXE Signature Serum - Front">
                            </div>
                            <div class="product-face back">
                            </div>
                        </div>
                    </div>
                    <div class="product-controls">
                        <button class="btn btn-dark" data-action="rotate-left" title="Rotate Left"><i class="fas fa-undo"></i></button>
                        <button class="btn btn-dark" data-action="rotate-right" title="Rotate Right"><i class="fas fa-redo"></i></button>
                        <button class="btn btn-dark" data-action="rotate-up" title="Rotate Up"><i class="fas fa-arrow-up"></i></button>
                        <button class="btn btn-dark" data-action="rotate-down" title="Rotate Down"><i class="fas fa-arrow-down"></i></button>
                        <button class="btn btn-dark" data-action="reset-view" title="Reset View"><i class="fas fa-sync-alt"></i></button>
                    </div>
                    <div class="text-center">
                        <h3>LUXE Signature Serum</h3>
                        <p class="text-muted" style="max-width: 600px; margin: 1rem auto;">Our premium anti-aging serum combines cutting-edge science with natural ingredients. Drag the product to explore or use the controls.</p>
                        <button class="btn btn-primary" id="shop-now-btn" title="Shopping feature coming soon!">Shop Now</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Profile Section -->
        <section class="section user-section" id="profile">
            <div class="container user-container">
                <div class="user-sidebar">
                    <div class="user-header">
                        <div class="user-pic" id="profile-initials">G</div>
                        <h3 class="user-name" id="profile-username">Guest User</h3>
                        <span class="user-meta" id="member-since">Login to see details</span>
                    </div>
                    <ul class="user-menu profile-menu">
                         <li><a data-tab="appointments" class="active"><i class="far fa-calendar-check"></i> My Appointments</a></li>
                         <li><a data-tab="profile-info"><i class="far fa-user-circle"></i> Profile Info</a></li>
                         <li><a data-tab="history"><i class="fas fa-history"></i> Booking History</a></li>
                         <li><a data-tab="favorites"><i class="far fa-heart"></i> Favorite Services</a></li>
                         <li><a data-tab="settings"><i class="fas fa-cog"></i> Settings</a></li>
                    </ul>
                </div>
                <div class="user-content">
                     <!-- Appointments Tab -->
                    <div class="user-content-tab active" id="profile-appointments-content">
                        <h2>My Upcoming Appointments</h2>
                        <p>View and manage your scheduled appointments.</p>
                        <div class="appointments-calendar-container" id="profile-calendar">
                            <p class="text-muted text-center" style="padding-top: 2rem;">Loading calendar...</p>
                        </div>
                    </div>
                     <!-- Profile Info Tab -->
                    <div class="user-content-tab" id="profile-profile-info-content">
                        <h2>Profile Information</h2>
                         <div id="profile-alert-area"></div>
                        <form id="profile-info-form" novalidate>
                            <div class="form-group">
                                <label for="profile-info-name">Full Name</label>
                                <input type="text" id="profile-info-name" value="Guest User" readonly required>
                            </div>
                            <div class="form-group">
                                <label for="profile-info-email">Email</label>
                                <input type="email" id="profile-info-email" value="guest@example.com" readonly>
                            </div>
                            <div class="form-group">
                                <label for="profile-info-phone">Phone</label>
                                <input type="tel" id="profile-info-phone" value="" readonly placeholder="Add phone number...">
                            </div>
                            <button type="button" class="btn btn-outline" id="edit-profile-btn"><i class="fas fa-pencil-alt"></i> Edit Profile</button>
                            <button type="submit" class="btn btn-primary" id="save-profile-btn" style="display: none;">
                                <span class="btn-text">Save Changes</span>
                                <span class="spinner"></span>
                            </button>
                        </form>
                    </div>
                    <!-- History Tab -->
                    <div class="user-content-tab" id="profile-history-content">
                        <h2>Booking History</h2>
                        <p>Your past appointments and services.</p>
                        <ul id="booking-history-list">
                            <li>Login to view your booking history</li>
                        </ul>
                    </div>
                    <!-- Favorites Tab -->
                    <div class="user-content-tab" id="profile-favorites-content">
                        <h2>Favorite Services</h2>
                        <p>Your most loved treatments for quick booking.</p>
                        <ul id="favorite-services-list">
                             <li>Login to manage your favorite services</li>
                        </ul>
                    </div>
                    <!-- Settings Tab -->
                    <div class="user-content-tab" id="profile-settings-content">
                        <h2>Account Settings</h2>
                        <p>Customize your preferences and notifications.</p>
                         <div id="settings-alert-area"></div>
                        <form id="profile-settings-form" novalidate>
                             <div class="form-group">
                                <label for="notifications">Email Notifications</label>
                                <select id="notifications" disabled>
                                    <option value="all">All notifications</option>
                                    <option value="reminders">Reminders only</option>
                                    <option value="none">None</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="preferred-time">Preferred Booking Time</label>
                                <select id="preferred-time" disabled>
                                    <option value="any">Any Time</option>
                                    <option value="morning">Morning (9am-12pm)</option>
                                    <option value="afternoon">Afternoon (12pm-5pm)</option>
                                    <option value="evening">Evening (5pm-8pm)</option>
                                </select>
                            </div>
                             <button type="submit" class="btn btn-primary" id="save-settings-btn" disabled>
                                <span class="btn-text">Save Settings</span>
                                <span class="spinner"></span>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </section>

        <!-- Admin Section -->
        <section class="section user-section" id="admin">
            <div class="admin-header container">
                <h2>Admin Dashboard</h2>
                <button class="btn btn-outline" id="admin-logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
            <div class="container user-container">
                <div class="user-sidebar">
                    <ul class="user-menu admin-menu">
                        <li><a data-tab="dashboard" class="active"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                        <li><a data-tab="bookings"><i class="far fa-calendar-alt"></i> Manage Bookings</a></li>
                        <li><a data-tab="clients"><i class="fas fa-users"></i> Clients</a></li>
                        <li><a data-tab="services"><i class="fas fa-spa"></i> Services</a></li>
                        <li><a data-tab="reports"><i class="far fa-chart-bar"></i> Reports</a></li>
                    </ul>
                </div>
                <div class="user-content">
                    <!-- Dashboard Tab -->
                    <div class="user-content-tab active" id="admin-dashboard-content">
                         <h2>Dashboard Overview</h2>
                         <div class="admin-main-grid">
                             <div class="stats-card">
                                <h3>Today's Appointments</h3>
                                <div class="chart-container"><canvas id="todayChart"></canvas></div>
                            </div>
                            <div class="stats-card">
                                <h3>Monthly Revenue</h3>
                                <div class="chart-container"><canvas id="revenueChart"></canvas></div>
                            </div>
                            <div class="stats-card">
                                <h3>Popular Services</h3>
                                <div class="chart-container"><canvas id="servicesChart"></canvas></div>
                            </div>
                        </div>
                    </div>
                    <!-- Bookings Tab -->
                    <div class="user-content-tab" id="admin-bookings-content">
                        <h2>Manage All Bookings</h2>
                        <p>View, modify, or add appointments for any client.</p>
                        <div class="admin-calendar-container" id="admin-calendar">
                            <p class="text-muted text-center" style="padding-top: 2rem;">Loading calendar...</p>
                        </div>
                    </div>
                    <!-- Clients Tab -->
                    <div class="user-content-tab" id="admin-clients-content">
                        <h2>Client Management</h2>
                        <p>View and manage your client database.</p>
                        <div class="placeholder-content">
                            <i class="fas fa-users fa-3x"></i>
                            <p>Client management interface coming soon.</p>
                        </div>
                    </div>
                     <!-- Services Tab -->
                    <div class="user-content-tab" id="admin-services-content">
                        <h2>Service Management</h2>
                        <p>Add, edit, and manage your salon services.</p>
                         <div class="placeholder-content">
                            <i class="fas fa-spa fa-3x"></i>
                            <p>Service management interface coming soon.</p>
                        </div>
                    </div>
                    <!-- Reports Tab -->
                    <div class="user-content-tab" id="admin-reports-content">
                        <h2>Reports & Analytics</h2>
                        <p>Generate detailed reports and business insights.</p>
                         <div class="placeholder-content">
                            <i class="fas fa-chart-line fa-3x"></i>
                            <p>Reporting features coming soon.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer>
        <div class="footer-content container">
             <div class="footer-column">
                <h3>LUXE Beauty</h3>
                <p>Experience the art of beauty with our premium cosmetic treatments, personalized care, and luxurious atmosphere. Book your transformation today.</p>
                <div class="social-links">
                    <a href="#" aria-label="Facebook" target="_blank" rel="noopener noreferrer"><i class="fab fa-facebook-f"></i></a>
                    <a href="#" aria-label="Instagram" target="_blank" rel="noopener noreferrer"><i class="fab fa-instagram"></i></a>
                    <a href="#" aria-label="Twitter" target="_blank" rel="noopener noreferrer"><i class="fab fa-twitter"></i></a>
                    <a href="#" aria-label="Pinterest" target="_blank" rel="noopener noreferrer"><i class="fab fa-pinterest-p"></i></a>
                </div>
            </div>
            <div class="footer-column">
                <h3>Quick Links</h3>
                <ul>
                    <li><a href="#home"><i class="fas fa-chevron-right"></i> Home</a></li>
                    <li><a href="#services"><i class="fas fa-chevron-right"></i> Services</a></li>
                    <li><a href="#booking"><i class="fas fa-chevron-right"></i> Booking</a></li>
                    <li><a href="#products"><i class="fas fa-chevron-right"></i> Products</a></li>
                    <li><a href="#" title="Link not active (Demo)"><i class="fas fa-chevron-right"></i> About Us</a></li>
                    <li><a href="#" title="Link not active (Demo)"><i class="fas fa-chevron-right"></i> Contact</a></li>
                    <li><a href="#profile" id="footer-profile-link"><i class="fas fa-chevron-right"></i> My Profile</a></li>
                </ul>
            </div>
            <div class="footer-column">
                <h3>Contact Us</h3>
                <ul>
                    <li><i class="fas fa-map-marker-alt"></i> 123 Beauty St, Luxury District, Suite 100</li>
                    <li><a href="tel:+15551234567"><i class="fas fa-phone"></i> (555) 123-4567</a></li>
                    <li><a href="mailto:info@luxebeauty.com"><i class="fas fa-envelope"></i> info@luxebeauty.com</a></li>
                    <li><i class="fas fa-clock"></i> Mon - Sat: 9:00 AM - 8:00 PM</li>
                    <li><i class="far fa-clock"></i> Sun: Closed</li>
                </ul>
            </div>
        </div>
        <div class="copyright container">
            <p>&copy; <span id="copyright-year"></span> LUXE Beauty. All rights reserved. | <a href="#" title="Link not active (Demo)">Privacy Policy</a> | <a href="#" title="Link not active (Demo)">Terms of Service</a></p>
        </div>
    </footer>

    <!-- Modals -->
    <div class="modal" id="login-modal">
        <div class="modal-content">
             <div class="modal-header">
                <h3>Login</h3>
                <button class="close-modal" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="login-alert-area"></div>
                <form id="login-form" novalidate>
                     <div class="form-group">
                        <label for="login-email-input">Email</label>
                        <input type="email" id="login-email-input" required placeholder="your.email@example.com" autocomplete="email">
                        <div class="error-message" data-error-for="login-email"></div>
                    </div>
                    <div class="form-group">
                        <label for="login-password-input">Password</label>
                        <input type="password" id="login-password-input" required placeholder="Enter your password" autocomplete="current-password">
                        <div class="error-message" data-error-for="login-password"></div>
                    </div>
                    <button type="submit" class="submit-btn" id="login-submit-btn">
                        <span class="btn-text">Login</span>
                        <span class="spinner"></span>
                    </button>
                </form>
                <p class="switch-modal-link">Don't have an account? <a id="switch-to-signup">Sign up</a></p>
            </div>
        </div>
    </div>

    <div class="modal" id="signup-modal">
        <div class="modal-content">
             <div class="modal-header">
                <h3>Create Account</h3>
                <button class="close-modal" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body">
                 <div id="signup-alert-area"></div>
                <form id="signup-form" novalidate>
                     <div class="form-group">
                        <label for="signup-name-input">Full Name</label>
                        <input type="text" id="signup-name-input" required placeholder="e.g., Jane Doe" autocomplete="name">
                        <div class="error-message" data-error-for="signup-name"></div>
                    </div>
                    <div class="form-group">
                        <label for="signup-email-input">Email</label>
                        <input type="email" id="signup-email-input" required placeholder="your.email@example.com" autocomplete="email">
                        <div class="error-message" data-error-for="signup-email"></div>
                    </div>
                    <div class="form-group">
                        <label for="signup-phone-input">Phone (Optional)</label>
                        <input type="tel" id="signup-phone-input" placeholder="(555) 123-4567" autocomplete="tel">
                         <small class="text-muted">Used for appointment reminders.</small>
                    </div>
                    <div class="form-group">
                        <label for="signup-password-input">Password</label>
                        <input type="password" id="signup-password-input" required placeholder="Minimum 8 characters" minlength="8" autocomplete="new-password">
                        <div class="error-message" data-error-for="signup-password"></div>
                    </div>
                    <div class="form-group">
                        <label for="signup-confirm-input">Confirm Password</label>
                        <input type="password" id="signup-confirm-input" required autocomplete="new-password">
                        <div class="error-message" data-error-for="signup-confirm">Passwords do not match.</div>
                    </div>
                    <button type="submit" class="submit-btn" id="signup-submit-btn">
                        <span class="btn-text">Create Account</span>
                        <span class="spinner"></span>
                    </button>
                </form>
                <p class="switch-modal-link">Already have an account? <a id="switch-to-login">Login</a></p>
            </div>
        </div>
    </div>

    <div class="modal" id="booking-modal">
        <div class="modal-content">
             <div class="modal-header">
                <h3 id="booking-modal-title">Book Appointment</h3>
                <button class="close-modal" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body">
                 <div id="booking-alert-area"></div>
                <form id="booking-form" novalidate>
                    <input type="hidden" id="selected-time" name="selected_time">
                    <p id="booking-login-prompt">Please <a class="modal-login-link">login</a> or <a class="modal-signup-link">sign up</a> to book an appointment.</p>
                    <div class="form-group">
                        <label for="booking-service">1. Service</label>
                        <select id="booking-service" name="service_id" required>
                             <option value="" disabled selected>Select a service...</option>
                        </select>
                        <div class="error-message" data-error-for="booking-service"></div>
                    </div>
                    <div class="form-group">
                        <label for="booking-date">2. Date</label>
                        <input type="text" id="booking-date-display" name="booking_date_display" placeholder="Select date from main calendar or card" readonly required style="cursor: default; background-color: var(--light-gray);">
                        <input type="hidden" id="booking-date" name="booking_date">
                        <div class="error-message" data-error-for="booking-date"></div>
                    </div>
                     <div class="form-group">
                        <label>3. Available Time</label>
                        <div class="time-slots-container">
                            <div class="time-slots-loader" id="time-slots-loader">
                                 <div class="spinner spinner-sm"></div>
                            </div>
                            <div class="time-slots-grid" id="time-slots-grid">
                                <p class="no-slots-message" id="no-slots-message">Select service and date to see times.</p>
                            </div>
                        </div>
                         <div class="error-message" data-error-for="booking-time"></div>
                    </div>
                     <div class="form-group">
                        <label for="booking-notes">4. Special Requests (Optional)</label>
                        <textarea id="booking-notes" name="notes" rows="3" placeholder="Any special requirements or notes..."></textarea>
                    </div>
                     <button type="submit" class="submit-btn" id="confirm-booking-btn" disabled>
                         <span class="btn-text">Confirm Booking</span>
                         <span class="spinner"></span>
                     </button>
                </form>
            </div>
        </div>
    </div>

    <template id="alert-template">
         <div class="alert" role="alert">
             <i class="alert-icon fa-solid"></i>
             <p class="alert-message"></p>
         </div>
    </template>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

    <script>
        (function() {
            'use strict';

            // --- UTILITIES ---
            const Utils = {
                $: (selector, context = document) => context.querySelector(selector),
                $$: (selector, context = document) => Array.from(context.querySelectorAll(selector)),
                debounce: (func, wait) => {
                    let timeout;
                    return function executedFunction(...args) {
                        const later = () => { clearTimeout(timeout); func(...args); };
                        clearTimeout(timeout);
                        timeout = setTimeout(later, wait);
                    };
                },
                formatISODate: (date, addDays = 0) => {
                    const d = new Date(date);
                    d.setDate(d.getDate() + addDays);
                    const year = d.getFullYear();
                    const month = (d.getMonth() + 1).toString().padStart(2, '0');
                    const day = d.getDate().toString().padStart(2, '0');
                    return `${year}-${month}-${day}`;
                },
                 formatDisplayDate: (dateStr) => {
                     if (!dateStr) return '';
                     const date = new Date(dateStr + 'T00:00:00'); // Use T00:00:00 to avoid timezone interpretation issues
                     if (isNaN(date)) return '';
                     return date.toLocaleDateString('en-US', {
                         weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                     });
                },
                 formatDisplayTime: (timeStr) => {
                    if (!timeStr) return '';
                    const [hour, minute] = timeStr.split(':');
                    const date = new Date(); // Use current date just to format time
                    date.setHours(parseInt(hour, 10), parseInt(minute, 10), 0, 0);
                    if (isNaN(date)) return '';
                    return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
                },
                sanitizeHTML: (str) => { // Basic sanitization
                    const temp = document.createElement('div');
                    temp.textContent = str;
                    return temp.innerHTML.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                },
                isValidEmail: (email) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email),
                getInitials: (name) => {
                    if (!name) return '?';
                    return name.split(' ')
                        .map(part => part[0])
                        .filter(char => char && char.match(/[a-zA-Z]/)) // Filter out non-alpha chars
                        .slice(0, 2)
                        .join('')
                        .toUpperCase() || '?'; // Fallback if no valid initials found
                }
            };

            // --- STATE MANAGER ---
            // Manages the application's state, including login status and current user.
            const StateManager = {
                _state: {
                    isLoggedIn: false,
                    currentUser: null, // Will hold { id, name, email, phone, isAdmin, joinDate, preferences, bookings, token }
                    activeSection: 'home',
                    activeProfileTab: 'appointments',
                    activeAdminTab: 'dashboard',
                    bookingModalData: { serviceId: null, date: null, time: null }
                },
                getState(key) { return this._state[key]; },
                setState(key, value) {
                    // Avoid unnecessary updates if the value hasn't changed (primitive check)
                    // For objects/arrays, a deeper comparison might be needed if mutations are possible elsewhere,
                    // but here we generally replace the whole object.
                    if (this._state[key] === value && typeof value !== 'object') return;

                    console.log(`State change: ${key} =`, value);
                    this._state[key] = value;

                    // Trigger UI updates or other actions based on state changes
                    switch(key) {
                         case 'isLoggedIn':
                         case 'currentUser': // Often updated together
                             UI.updateAuthNav();
                             UI.updateProfileDisplay();
                             UI.updateBookingModalAccess();
                             UI.updateFooterLinks();
                             CalendarManager.refreshAllUserCalendars(); // Refresh calendars dependent on user data
                             break;
                         case 'activeSection':
                             UI.showSection(value); // Handles displaying the correct section and scrolling
                             UI.updateActiveNavLink(); // Updates nav highlight
                             break;
                         case 'activeProfileTab':
                             UI.updateTabs('.profile-menu', '#profile .user-content-tab', value, 'profile'); // Handles profile tab switching
                             break;
                         case 'activeAdminTab':
                             UI.updateTabs('.admin-menu', '#admin .user-content-tab', value, 'admin'); // Handles admin tab switching
                             break;
                         case 'bookingModalData':
                            // Trigger fetching available times when service or date changes in the modal
                            BookingModalManager.fetchAndDisplayAvailableTimes();
                            // Update the confirmation button state based on complete data and login status
                            BookingModalManager.updateBookingButtonState();
                            break;
                    }
                },
                // Convenience getters
                isLoggedIn: () => StateManager.getState('isLoggedIn'),
                isAdmin: () => StateManager.getState('currentUser')?.isAdmin ?? false,
                getUser: () => StateManager.getState('currentUser'),
                // Convenience setter for booking modal data (ensures state update logic runs)
                setBookingModalData(newData) {
                    const currentData = StateManager.getState('bookingModalData');
                    const updatedData = { ...currentData, ...newData };
                    // Only update state if data actually changed (simple JSON comparison)
                    if (JSON.stringify(currentData) !== JSON.stringify(updatedData)) {
                        StateManager.setState('bookingModalData', updatedData);
                    }
                },
                getBookingModalData: () => StateManager.getState('bookingModalData'),
                resetBookingModalData: () => {
                    // Reset to initial empty state
                    StateManager.setState('bookingModalData', { serviceId: null, date: null, time: null });
                }
            };


            // --- MOCK API ---
            // Simulates backend responses for demonstration purposes.
            const API = {
                 _delay: (ms) => new Promise(resolve => setTimeout(resolve, ms)), // Simulates network latency
                 // Simple in-memory user store (Password stored plaintext for demo ONLY. NEVER do this in production.)
                 _users: {
                     'admin@luxe.com': { password: 'adminpassword', data: { id: 'admin01', name: 'Admin Luxe', email: 'admin@luxe.com', phone: '(555) 000-ADMIN', isAdmin: true, joinDate: '2022', preferences: { notifications: 'all', favorites: ['signature-facial'], preferredTime: 'any' }, bookings: [] } },
                     'user@luxe.com': { password: 'userpassword', data: { id: 'user01', name: 'Jane Doe', email: 'user@luxe.com', phone: '(555) 111-USER', isAdmin: false, joinDate: '2023', preferences: { notifications: 'reminders', favorites: ['microblading', 'laser-hair'], preferredTime: 'afternoon' }, bookings: [
                         { id: 'b1', title: 'Signature Facial', start: Utils.formatISODate(new Date(), -10) + 'T10:00:00', end: Utils.formatISODate(new Date(), -10) + 'T11:00:00', serviceId: 'signature-facial', notes: 'Past appt' },
                         { id: 'b2', title: 'Microblading', start: Utils.formatISODate(new Date(), 5) + 'T14:00:00', end: Utils.formatISODate(new Date(), 5) + 'T15:30:00', serviceId: 'microblading', notes: '' },
                         { id: 'b3', title: 'Laser Hair Removal', start: Utils.formatISODate(new Date(), 12) + 'T11:30:00', end: Utils.formatISODate(new Date(), 12) + 'T12:30:00', serviceId: 'laser-hair', notes: 'Upcoming' }
                     ] } }
                 },
                 // Fetch services list (e.g., for dropdowns)
                 getServices: async () => {
                     await API._delay(100); // Fast response
                     return [
                         { id: "signature-facial", name: "Signature Facial", price: 120 },
                         { id: "microblading", name: "Microblading", price: 350 },
                         { id: "laser-hair", name: "Laser Hair Removal", price: 250 },
                         { id: "body-scrub", name: "Body Scrub", price: 90 },
                         { id: "manicure", name: "Luxury Manicure", price: 60 }
                     ];
                 },
                 // AUTH: Login endpoint simulation
                 login: async (email, password) => {
                     await API._delay(800); // Simulate login delay
                     const lowerEmail = email.toLowerCase();
                     const storedUser = API._users[lowerEmail];
                     if (storedUser && storedUser.password === password) {
                         console.log('API Login Success:', lowerEmail);
                         // Return user data + a mock session token
                         const user = { ...storedUser.data, token: `fake-token-${Date.now()}` };
                         return { success: true, user: user };
                     } else {
                         console.log('API Login Failed:', lowerEmail);
                         return { success: false, message: 'Invalid email or password.' };
                     }
                 },
                 // AUTH: Signup endpoint simulation
                 signup: async (name, email, phone, password) => {
                     await API._delay(1200); // Simulate signup delay
                     const lowerEmail = email.toLowerCase();
                     // Check if email already exists
                     if (API._users[lowerEmail]) {
                         return { success: false, message: 'An account with this email already exists.' };
                     }
                     // Create new user entry
                     const newUser = {
                         id: `user${Date.now()}`, name: name, email: lowerEmail, phone: phone || '', isAdmin: false,
                         joinDate: new Date().getFullYear().toString(),
                         preferences: { notifications: 'all', favorites: [], preferredTime: 'any' },
                         bookings: [], token: `fake-token-${Date.now()}` // Issue token immediately
                     };
                     // Add to mock DB (In real app, this saves to backend DB)
                     API._users[lowerEmail] = { password: password, data: newUser };
                     console.log('API Signup Success:', lowerEmail);
                     return { success: true, user: { ...newUser } }; // Return the new user object
                 },
                 // PROFILE: Update user profile simulation
                 updateProfile: async (userId, profileData, token) => {
                     await API._delay(700);
                     // Basic token check simulation
                     if (!token || !token.startsWith('fake-token-')) return { success: false, message: 'Authentication required.' };
                     const userEntry = Object.values(API._users).find(u => u.data.id === userId);
                     if (!userEntry) return { success: false, message: 'User not found.' };
                     // Update data
                     userEntry.data.name = profileData.name;
                     userEntry.data.phone = profileData.phone;
                     console.log('API Profile Update Success for user:', userId);
                     // Return updated user data (potentially with a refreshed token in a real app)
                     return { success: true, user: { ...userEntry.data, token: token } };
                 },
                  // PROFILE: Update user preferences simulation
                  updatePreferences: async (userId, preferencesData, token) => {
                     await API._delay(600);
                      if (!token || !token.startsWith('fake-token-')) return { success: false, message: 'Authentication required.' };
                     const userEntry = Object.values(API._users).find(u => u.data.id === userId);
                     if (!userEntry) return { success: false, message: 'User not found.' };
                      userEntry.data.preferences.notifications = preferencesData.notifications;
                      userEntry.data.preferences.preferredTime = preferencesData.preferredTime;
                     console.log('API Preferences Update Success for user:', userId);
                      return { success: true, user: { ...userEntry.data, token: token } }; // Return updated user data + token
                  },
                  // CALENDAR: Fetch main calendar background availability
                  getMainCalendarAvailability: async (fetchInfo) => {
                     const startStr = fetchInfo.startStr.split('T')[0]; // Get YYYY-MM-DD
                     const endStr = fetchInfo.endStr.split('T')[0];
                     console.log(`API Sim: Fetching MAIN calendar availability from ${startStr} to ${endStr}`);
                     await API._delay(500); // Simulate fetch delay

                     // Static definition of busy days for demo
                     const fixedAvailability = {
                         [Utils.formatISODate(new Date(), 3)]: 'limited', // Limited slots 3 days from now
                         [Utils.formatISODate(new Date(), 5)]: 'full',    // Fully booked 5 days from now
                         [Utils.formatISODate(new Date(), 6)]: 'full',    // Fully booked 6 days from now
                         [Utils.formatISODate(new Date(), 10)]: 'limited',
                         [Utils.formatISODate(new Date(), 11)]: 'limited',
                         [Utils.formatISODate(new Date(), 17)]: 'full',
                     };

                     // Convert to FullCalendar background event objects
                     const events = Object.entries(fixedAvailability).map(([date, status]) => ({
                         start: date, // Date is enough for background events
                         display: 'background',
                         extendedProps: { status: status } // Used by classNames callback
                     }));

                     console.log("API Sim: Returning availability events:", events);
                     return events; // Return array directly for FullCalendar
                 },
                  // CALENDAR: Fetch available time slots for a specific service and date
                  getAvailableTimes: async (serviceId, dateStr) => {
                     console.log(`API Sim: Fetching times for service ${serviceId} on ${dateStr}`);
                     if (!serviceId || !dateStr) return { success: false, message: "Service and date required.", times: [] };

                     await API._delay(650); // Simulate fetch delay

                     const now = new Date();
                     const isToday = dateStr === Utils.formatISODate(now);
                     const currentHour = now.getHours();
                     const currentMinute = now.getMinutes();

                      // Define base slots and service-specific variations
                      let potentialSlots = ['09:00', '09:30', '10:00', '10:30', '11:00', '11:30', '12:00', '13:00', '13:30', '14:00', '14:30', '15:00', '15:30', '16:00', '16:30', '17:00', '17:30', '18:00', '18:30', '19:00'];
                      if (serviceId === 'microblading') { potentialSlots = ['10:00', '13:00', '16:00']; } // Longer service, fewer slots
                      if (serviceId === 'body-scrub') { potentialSlots = ['09:30', '11:30', '14:30', '16:30']; }

                      // Simulate already booked slots based on date (matches fixedAvailability)
                      let bookedTimes = [];
                      if (dateStr === Utils.formatISODate(new Date(), 3)) bookedTimes = ['10:00', '14:30']; // Limited day
                      if (dateStr === Utils.formatISODate(new Date(), 7) && serviceId === 'signature-facial') bookedTimes = ['11:00', '11:30']; // Specific service conflict
                      if (dateStr === Utils.formatISODate(new Date(), 5)) bookedTimes = potentialSlots; // Fully booked day
                      if (dateStr === Utils.formatISODate(new Date(), 6)) bookedTimes = potentialSlots; // Fully booked day
                      if (dateStr === Utils.formatISODate(new Date(), 10)) bookedTimes = ['09:00', '13:00', '17:00', '17:30']; // Limited day
                      if (dateStr === Utils.formatISODate(new Date(), 11)) bookedTimes = ['11:00', '11:30', '15:00']; // Limited day
                      if (dateStr === Utils.formatISODate(new Date(), 17)) bookedTimes = potentialSlots; // Fully booked day


                     // Filter out booked slots and past times for today
                     let availableSlots = potentialSlots.filter(time => {
                         if (bookedTimes.includes(time)) return false; // Remove booked
                         if (isToday) {
                             const [slotHour, slotMinute] = time.split(':').map(Number);
                             const slotTimeMinutes = slotHour * 60 + slotMinute;
                             const currentTimeMinutes = currentHour * 60 + currentMinute;
                             // Add buffer (e.g., 15 mins) - cannot book times starting too soon
                             if (slotTimeMinutes <= currentTimeMinutes + 15) return false;
                         }
                         return true; // Available
                     });

                     console.log(`API Sim: Returning slots for ${dateStr}, service ${serviceId}:`, availableSlots);
                     return { success: true, times: availableSlots };
                 },
                 // BOOKING: Submit a new appointment
                 bookAppointment: async (userId, bookingData, token) => {
                     console.log("API Sim: Submitting booking:", bookingData);
                     if (!token || !token.startsWith('fake-token-')) return { success: false, message: "Authentication required. Please log in." };
                     if (!userId) return { success: false, message: "User information missing." };

                     const userEntry = Object.values(API._users).find(u => u.data.id === userId);
                     if (!userEntry) return { success: false, message: "User not found." };

                     await API._delay(1000); // Simulate booking processing time

                     // Simulate potential conflict based on the 'full' days defined earlier
                     if (bookingData.date === Utils.formatISODate(new Date(), 5) || bookingData.date === Utils.formatISODate(new Date(), 6) || bookingData.date === Utils.formatISODate(new Date(), 17) ) {
                          return { success: false, message: "Sorry, there was a conflict booking this time. The day may have become fully booked. Please select another." };
                     }
                     // Simulate another potential random conflict AFTER the delay
                     if (Math.random() < 0.1) { // 10% chance of random conflict
                          console.warn("API Sim: Simulated random booking conflict.");
                          return { success: false, message: "Sorry, that time slot was just booked by another user. Please select a different time." };
                     }

                     // Determine service details (title, duration)
                     const serviceInfo = await API.getServices().then(s => s.find(service => service.id === bookingData.serviceId));
                     const title = serviceInfo ? serviceInfo.name : 'Appointment';
                     // Estimate duration based on service type (adjust as needed)
                     const durationMinutes = serviceInfo?.id === 'microblading' ? 90 : (serviceInfo?.id === 'laser-hair' ? 60 : 60);
                     const startDateTime = new Date(`${bookingData.date}T${bookingData.time}:00`);
                     const endDateTime = new Date(startDateTime.getTime() + durationMinutes * 60000);

                     // Create the new booking object
                     const newBooking = {
                         id: `b${Date.now()}`, // Simple unique ID
                         title: title,
                         start: startDateTime.toISOString(), // Store in ISO format
                         end: endDateTime.toISOString(),
                         serviceId: bookingData.serviceId,
                         notes: bookingData.notes || ''
                     };

                     // Add booking to the mock user's data
                     userEntry.data.bookings.push(newBooking);
                     console.log('API Booking Success for user:', userId, newBooking);

                     // Return success and the ID of the new booking
                     return { success: true, bookingId: newBooking.id, message: "Your appointment is confirmed!" };
                 },
                 // CALENDAR: Fetch appointments for a specific user (Profile)
                 getUserAppointments: async (userId, token) => {
                     await API._delay(300);
                     if (!token || !token.startsWith('fake-token-')) return []; // Auth check
                     const userEntry = Object.values(API._users).find(u => u.data.id === userId);
                     if (!userEntry) return []; // User not found
                     // Map stored bookings to FullCalendar event format
                     return userEntry.data.bookings.map(b => ({
                         id: b.id,
                         title: b.title,
                         start: b.start,
                         end: b.end,
                         color: 'var(--gold-accent)', // User-specific color
                         extendedProps: { serviceId: b.serviceId, notes: b.notes }
                     }));
                 },
                  // CALENDAR: Fetch all appointments for Admin view
                  getAdminAllAppointments: async (token) => {
                     await API._delay(500);
                      if (!token || !token.startsWith('fake-token-')) return []; // Auth check
                      // Ensure the caller is an admin
                      const adminUser = Object.values(API._users).find(u => u.data.token === token && u.data.isAdmin);
                      if (!adminUser) return [];

                     let allEvents = [];
                     // Iterate through all users and their bookings
                     Object.values(API._users).forEach(userEntry => {
                         userEntry.data.bookings.forEach(b => {
                             allEvents.push({
                                 id: b.id,
                                 title: `${b.title} - ${userEntry.data.name}`, // Add client name to title
                                 start: b.start,
                                 end: b.end,
                                 extendedProps: { userId: userEntry.data.id, clientName: userEntry.data.name, serviceId: b.serviceId, notes: b.notes },
                                 // Differentiate color for admin vs regular user bookings if desired
                                 color: userEntry.data.isAdmin ? 'var(--deep-navy)' : 'var(--gold-accent)',
                                 textColor: userEntry.data.isAdmin ? 'var(--soft-white)' : 'var(--deep-navy)',
                             });
                         });
                     });
                     // Add non-client events (e.g., maintenance, meetings)
                     allEvents.push(
                          { id: 'maint1', title: 'Blocked: Room Maintenance', start: Utils.formatISODate(new Date(), 4) + 'T13:00:00', end: Utils.formatISODate(new Date(), 4) + 'T15:00:00', display: 'background', color: 'var(--text-muted)' },
                          { id: 'meet1', title: 'Team Meeting', start: Utils.formatISODate(new Date(), 1) + 'T09:00:00', end: Utils.formatISODate(new Date(), 1) + 'T10:00:00', color: 'var(--info-blue)', textColor: 'var(--soft-white)' }
                     );
                     return allEvents;
                 },
                  // CALENDAR: Update booking time/date via drag/drop (Admin)
                  updateAdminBooking: async (bookingId, newStart, newEnd, token) => {
                      await API._delay(400); // Simulate update delay
                       if (!token || !token.startsWith('fake-token-')) return { success: false, message: 'Authentication required.' };
                       if (!StateManager.isAdmin()) return { success: false, message: 'Admin permissions required.' }; // Double check permissions server-side conceptually

                       console.log(`API Sim: Updating booking ${bookingId} to ${newStart} - ${newEnd || '(end time not provided)'}`);
                       let found = false;
                       // Find the booking across all users
                       for (const userEmail in API._users) {
                            const userEntry = API._users[userEmail];
                            const bookingIndex = userEntry.data.bookings.findIndex(b => b.id === bookingId);
                            if (bookingIndex !== -1) {
                                // Update the booking details
                                userEntry.data.bookings[bookingIndex].start = newStart;
                                // Handle potential null end time if dropped on all-day slot (may need duration recalc)
                                userEntry.data.bookings[bookingIndex].end = newEnd || userEntry.data.bookings[bookingIndex].end; // Keep old end if new one is null (simplistic)
                                found = true;
                                break; // Stop searching once found
                            }
                       }

                       if (found) {
                           console.log(`API Sim: Booking ${bookingId} updated in mock DB.`);
                           return { success: true, message: 'Booking updated successfully.' };
                       } else {
                           console.error(`API Sim: Booking ${bookingId} not found for update.`);
                           return { success: false, message: 'Booking not found.' };
                       }
                  }
            };


            // --- AUTHENTICATION ---
            // Handles login, signup, logout logic and interacts with StateManager and API.
             const Auth = {
                 // Check localStorage on page load to see if user was previously logged in.
                 checkLoginStatus: () => {
                     try {
                         const storedUser = localStorage.getItem('luxeUser');
                         if (storedUser) {
                             const user = JSON.parse(storedUser);
                             // Basic validation: Check if essential user data and token exist.
                             // In a real app, you'd validate the token against the backend here.
                             if (user && user.id && user.email && user.token) {
                                 StateManager.setState('currentUser', user);
                                 StateManager.setState('isLoggedIn', true);
                                 console.log("User logged in from storage:", user.email);
                             } else {
                                 console.log("Invalid user data in storage, clearing.");
                                 localStorage.removeItem('luxeUser'); // Clear invalid data
                             }
                         }
                     } catch (e) {
                         console.error("Error reading login status from storage:", e);
                         localStorage.removeItem('luxeUser'); // Clear storage on error
                     }
                 },
                 // Handles the login process.
                 handleLogin: async (email, password) => {
                     const result = await API.login(email, password);
                     if (result.success) {
                         // Update application state
                         StateManager.setState('currentUser', result.user);
                         StateManager.setState('isLoggedIn', true);
                         // Persist user data (including token) to localStorage (for demo)
                         try { localStorage.setItem('luxeUser', JSON.stringify(result.user)); }
                         catch (e) { console.error("Error saving user to storage:", e); }
                         // Close modal and navigate to appropriate section
                         UI.closeModal('login-modal');
                         UI.navigateToSection(result.user.isAdmin ? 'admin' : 'profile');
                     }
                     // Return result for UI feedback (e.g., showing error messages)
                     return result;
                 },
                 // Handles the signup process.
                 handleSignup: async (name, email, phone, password) => {
                     const result = await API.signup(name, email, phone, password);
                     if (result.success) {
                         // Update application state
                         StateManager.setState('currentUser', result.user);
                         StateManager.setState('isLoggedIn', true);
                         // Persist new user data to localStorage
                         try { localStorage.setItem('luxeUser', JSON.stringify(result.user)); }
                         catch (e) { console.error("Error saving user to storage:", e); }
                         // Show success message, wait briefly, then close modal and navigate
                         UI.displayAlert('signup-alert-area', 'success', 'Account created successfully! Redirecting...', '', 2000);
                         await API._delay(2100); // Allow time to read message
                         UI.closeModal('signup-modal');
                         UI.navigateToSection('profile'); // Go to profile after signup
                     }
                     return result;
                 },
                 // Handles the logout process.
                 logout: () => {
                     // Clear application state
                     StateManager.setState('currentUser', null);
                     StateManager.setState('isLoggedIn', false);
                      // Clear persisted data
                      try { localStorage.removeItem('luxeUser'); }
                      catch (e) { console.error("Error removing user from storage:", e); }
                     // Reset UI
                     StateManager.setState('activeSection', 'home'); // Go to home page
                     UI.clearSensitiveData(); // Clear forms, calendars etc.
                     console.log("User logged out");
                 }
             };


             // --- UI MANAGER ---
             // Handles all DOM manipulations and UI updates.
             const UI = {
                 elements: {}, // Cache for frequently accessed DOM elements
                 // Find and store references to key DOM elements
                 initDOMReferences: () => {
                     UI.elements = {
                         // Navigation & Auth Buttons
                         nav: Utils.$('#main-nav'), navLinksContainer: Utils.$('#nav-links'), navLinks: Utils.$$('.nav-links a'),
                         burgerMenu: Utils.$('#burger-menu'), loginBtn: Utils.$('#login-btn'), signupBtn: Utils.$('#signup-btn'),
                         logoutBtn: Utils.$('#logout-btn'), profileLink: Utils.$('#profile-link'), adminLink: Utils.$('#admin-link'),
                         footerProfileLink: Utils.$('#footer-profile-link'),
                         // Main Content Sections
                         mainContent: Utils.$('#main-content'), allSections: Utils.$$('main > section'),
                         profileSection: Utils.$('#profile'), adminSection: Utils.$('#admin'), servicesGrid: Utils.$('.services-grid'),
                         // Modals & Forms
                         modals: Utils.$$('.modal'), loginModal: Utils.$('#login-modal'), signupModal: Utils.$('#signup-modal'),
                         bookingModal: Utils.$('#booking-modal'), loginForm: Utils.$('#login-form'), signupForm: Utils.$('#signup-form'),
                         bookingForm: Utils.$('#booking-form'), loginAlertArea: Utils.$('#login-alert-area'), signupAlertArea: Utils.$('#signup-alert-area'),
                         bookingAlertArea: Utils.$('#booking-alert-area'), modalLoginLink: Utils.$('.modal-login-link'), modalSignupLink: Utils.$('.modal-signup-link'),
                         // Booking Modal Specifics
                         bookingModalTitle: Utils.$('#booking-modal-title'), bookingServiceSelect: Utils.$('#booking-service'),
                         bookingDateDisplay: Utils.$('#booking-date-display'), bookingDateInput: Utils.$('#booking-date'),
                         bookingTimeSelectHidden: Utils.$('#selected-time'), bookingNotes: Utils.$('#booking-notes'),
                         confirmBookingBtn: Utils.$('#confirm-booking-btn'), bookingLoginPrompt: Utils.$('#booking-login-prompt'),
                         timeSlotsContainer: Utils.$('#booking-modal .time-slots-container'), timeSlotsGrid: Utils.$('#booking-modal #time-slots-grid'),
                         timeSlotsLoader: Utils.$('#booking-modal #time-slots-loader'), noSlotsMessage: Utils.$('#booking-modal #no-slots-message'),
                         // Main Calendar Elements
                         mainCalendarEl: Utils.$('#main-calendar'), calendarLoader: Utils.$('#calendar-loader'), calendarMessageArea: Utils.$('#calendar-message-area'),
                         // Profile Section Elements
                         profileInfoForm: Utils.$('#profile-info-form'), profileSettingsForm: Utils.$('#profile-settings-form'),
                         profileInitials: Utils.$('#profile-initials'), profileUsername: Utils.$('#profile-username'), memberSince: Utils.$('#member-since'),
                         profileInfoName: Utils.$('#profile-info-name'), profileInfoEmail: Utils.$('#profile-info-email'), profileInfoPhone: Utils.$('#profile-info-phone'),
                         editProfileBtn: Utils.$('#edit-profile-btn'), saveProfileBtn: Utils.$('#save-profile-btn'), profileAlertArea: Utils.$('#profile-alert-area'),
                         settingsAlertArea: Utils.$('#settings-alert-area'), bookingHistoryList: Utils.$('#booking-history-list'),
                         favoriteServicesList: Utils.$('#favorite-services-list'), notificationsSelect: Utils.$('#notifications'),
                         preferredTimeSelect: Utils.$('#preferred-time'), saveSettingsBtn: Utils.$('#save-settings-btn'),
                         profileCalendarEl: Utils.$('#profile-calendar'), profileMenu: Utils.$('.profile-menu'), profileTabs: Utils.$$('#profile .user-content-tab'),
                         // Admin Section Elements
                         adminLogoutBtn: Utils.$('#admin-logout-btn'), adminHeader: Utils.$('.admin-header'), adminCalendarEl: Utils.$('#admin-calendar'),
                         todayChartCanvas: Utils.$('#todayChart'), revenueChartCanvas: Utils.$('#revenueChart'), servicesChartCanvas: Utils.$('#servicesChart'),
                         adminMenu: Utils.$('.admin-menu'), adminTabs: Utils.$$('#admin .user-content-tab'),
                         // Product Viewer Elements
                         product3dContainer: Utils.$('.product-3d-container'), product3d: Utils.$('#product-3d'), productControls: Utils.$('.product-controls'),
                         shopNowBtn: Utils.$('#shop-now-btn'), // Added for placeholder handling
                         // Footer Elements
                         copyrightYear: Utils.$('#copyright-year')
                     };
                 },
                 // Update visibility of login/signup/logout buttons based on state
                 updateAuthNav: () => {
                     const loggedIn = StateManager.isLoggedIn(); const isAdmin = StateManager.isAdmin();
                     UI.elements.loginBtn.style.display = loggedIn ? 'none' : 'inline-flex';
                     UI.elements.signupBtn.style.display = loggedIn ? 'none' : 'inline-flex';
                     UI.elements.logoutBtn.style.display = loggedIn ? 'inline-flex' : 'none';
                     UI.elements.adminLogoutBtn.style.display = loggedIn && isAdmin ? 'inline-flex' : 'none'; // Specific to admin header
                     UI.elements.profileLink.style.display = loggedIn ? 'block' : 'none';
                     UI.elements.adminLink.style.display = loggedIn && isAdmin ? 'block' : 'none';
                 },
                 // Update the profile section sidebar and forms with user data or reset if logged out
                 updateProfileDisplay: () => {
                     const user = StateManager.getUser();
                     // Ensure profile section elements exist before trying to update
                     if (!UI.elements.profileSection) return;

                     if (user) { // Logged In
                         UI.elements.profileUsername.textContent = Utils.sanitizeHTML(user.name);
                         UI.elements.profileInitials.textContent = Utils.getInitials(user.name);
                         UI.elements.memberSince.textContent = `Member since ${user.joinDate || 'N/A'}`;
                         UI.elements.profileInfoName.value = Utils.sanitizeHTML(user.name);
                         UI.elements.profileInfoEmail.value = Utils.sanitizeHTML(user.email);
                         UI.elements.profileInfoPhone.value = Utils.sanitizeHTML(user.phone || '');
                         UI.elements.notificationsSelect.value = user.preferences?.notifications || 'all';
                         UI.elements.preferredTimeSelect.value = user.preferences?.preferredTime || 'any';
                         // Reset forms to non-editable state initially when data loads
                         UI.setProfileFormEditable(false);
                         UI.enableProfileSettingsForm(true); // Enable settings form for logged-in user
                         // Update dynamic lists
                         UI.updateBookingHistoryList();
                         UI.updateFavoritesList();
                     } else { // Logged Out
                         UI.elements.profileUsername.textContent = 'Guest User';
                         UI.elements.profileInitials.textContent = 'G';
                         UI.elements.memberSince.textContent = 'Login to view details';
                         // Reset forms
                         UI.elements.profileInfoForm?.reset();
                         UI.elements.profileSettingsForm?.reset();
                         // Ensure forms are locked/disabled
                         UI.setProfileFormEditable(false);
                         UI.enableProfileSettingsForm(false);
                         // Reset dynamic lists
                         UI.elements.bookingHistoryList.innerHTML = '<li>Login to view your booking history</li>';
                         UI.elements.favoriteServicesList.innerHTML = '<li>Login to manage your favorite services</li>';
                     }
                 },
                 // Show/hide profile link in footer based on login state
                 updateFooterLinks: () => { if (UI.elements.footerProfileLink) { UI.elements.footerProfileLink.style.display = StateManager.isLoggedIn() ? 'flex' : 'none'; } },
                 // Update the 'active' class on navigation links based on the current section
                 updateActiveNavLink: () => { const currentSection = StateManager.getState('activeSection'); UI.elements.navLinks.forEach(link => { link.classList.toggle('active', link.getAttribute('href') === `#${currentSection}`); }); },
                 // Show the target section and hide others, handle smooth scrolling
                 showSection: (sectionId) => {
                     console.log(`Showing section: ${sectionId}`); let foundSection = false;
                     UI.elements.allSections.forEach(section => {
                         const isActive = section.id === sectionId;
                         section.style.display = isActive ? 'block' : 'none'; // Show/hide
                         if (isActive) {
                             foundSection = true;
                             // Trigger initializations for sections that need it when shown
                             switch(sectionId) {
                                case 'profile':
                                    // Redirect if not logged in, otherwise ensure profile is updated and default tab shown
                                    if (!StateManager.isLoggedIn()) { UI.navigateToSection('home'); UI.openModal('login-modal'); }
                                    else { StateManager.setState('activeProfileTab', 'appointments'); UI.updateProfileDisplay(); }
                                    break;
                                case 'admin':
                                     // Redirect if not admin, otherwise ensure admin state is ready
                                     if (!StateManager.isLoggedIn() || !StateManager.isAdmin()) { UI.navigateToSection('home'); if(StateManager.isLoggedIn()) alert("Admin access required."); else UI.openModal('login-modal'); }
                                     else { StateManager.setState('activeAdminTab', 'dashboard'); ChartManager.initAllCharts(); } // Init charts only when tab is shown
                                     break;
                                // Add cases for other sections if needed (e.g., lazy loading)
                             }
                         }
                     });

                     if (foundSection) {
                         // Scroll to the top of the section, accounting for fixed nav height
                         const sectionElement = Utils.$(`#${sectionId}`);
                         if (sectionElement) {
                            const navHeight = UI.elements.nav?.offsetHeight || 70; // Get nav height or use default
                            const elementPosition = sectionElement.getBoundingClientRect().top + window.pageYOffset;
                            const offsetPosition = elementPosition - navHeight - 20; // Calculate position below nav + padding
                            window.scrollTo({ top: offsetPosition, behavior: 'smooth' });
                         }
                         UI.updateActiveNavLink(); // Highlight the correct nav link
                     } else {
                         // Fallback if the section ID doesn't exist
                         console.warn(`Section #${sectionId} not found, defaulting to home.`);
                         StateManager.setState('activeSection', 'home');
                     }
                     UI.closeMobileMenu(); // Close mobile menu after navigation
                 },
                 // Programmatically navigate to a section (updates state, triggers showSection)
                 navigateToSection: (sectionId) => { StateManager.setState('activeSection', sectionId); },
                 // Toggle mobile navigation menu
                 toggleMobileMenu: () => { UI.elements.burgerMenu?.classList.toggle('open'); UI.elements.navLinksContainer?.classList.toggle('open'); },
                 // Close mobile navigation menu
                 closeMobileMenu: () => { UI.elements.burgerMenu?.classList.remove('open'); UI.elements.navLinksContainer?.classList.remove('open'); },
                 // Open a modal by ID
                 openModal: (modalId) => {
                     const modal = Utils.$(`#${modalId}`);
                     if (modal) {
                         const form = Utils.$('form', modal); if(form) UI.resetForm(form); // Reset form inside modal
                         modal.classList.add('active'); document.body.classList.add('modal-open'); // Show modal, prevent body scroll
                         console.log(`Opened modal: ${modalId}`);
                         // Auto-focus the first focusable element in the modal
                         const firstInput = Utils.$('input:not([type=hidden]), select, textarea', modal); firstInput?.focus();
                     } else { console.warn(`Modal not found: ${modalId}`); }
                 },
                 // Close a modal by ID
                 closeModal: (modalId) => {
                     const modal = Utils.$(`#${modalId}`);
                     if (modal && modal.classList.contains('active')) {
                         modal.classList.remove('active');
                         // Only allow body scroll again if *no* modals are active
                         if (!Utils.$$('.modal.active').length) { document.body.classList.remove('modal-open'); }
                         console.log(`Closed modal: ${modalId}`);
                     }
                 },
                 // Close all currently active modals
                 closeAllModals: () => { UI.elements.modals.forEach(modal => modal.classList.remove('active')); document.body.classList.remove('modal-open'); },
                 // Reset a form's fields, errors, and loading state
                 resetForm: (formElement) => { if (formElement) { formElement.reset(); UI.resetFormErrors(formElement); UI.clearAlerts(formElement.id.replace('-form', '-alert-area')); UI.toggleLoadingState(formElement.querySelector('.btn.loading, .submit-btn.loading'), false); } },
                 // Show an inline error message for a specific form field
                 showError: (formElement, fieldName, message) => {
                     const errorEl = Utils.$(`[data-error-for="${fieldName}"]`, formElement);
                     // Attempt to find input by name or convention (e.g., 'login-email-input')
                     const inputEl = formElement.elements[fieldName] || formElement.elements[fieldName.replace(/-(\w)/g, (match, p1) => p1.toUpperCase())] || Utils.$(`#${fieldName}-input`, formElement) || Utils.$(`[name="${fieldName}"]`, formElement);
                     if (errorEl) { errorEl.textContent = message; errorEl.style.display = 'block'; }
                     // Add visual error state to the input/select/textarea
                     inputEl?.classList.add('error');
                     inputEl?.setAttribute('aria-invalid', 'true'); // Accessibility
                 },
                 // Hide an inline error message for a specific form field
                 hideError: (formElement, fieldName) => {
                      const errorEl = Utils.$(`[data-error-for="${fieldName}"]`, formElement);
                      const inputEl = formElement.elements[fieldName] || formElement.elements[fieldName.replace(/-(\w)/g, (match, p1) => p1.toUpperCase())] || Utils.$(`#${fieldName}-input`, formElement) || Utils.$(`[name="${fieldName}"]`, formElement);
                      if (errorEl) { errorEl.textContent = ''; errorEl.style.display = 'none'; }
                      inputEl?.classList.remove('error');
                      inputEl?.removeAttribute('aria-invalid');
                 },
                 // Reset all inline error messages and visual states within a form
                 resetFormErrors: (formElement) => { if (!formElement) return; Utils.$$('.error-message', formElement).forEach(el => { el.textContent = ''; el.style.display = 'none'; }); Utils.$$('input.error, select.error, textarea.error', formElement).forEach(el => { el.classList.remove('error'); el.removeAttribute('aria-invalid'); }); },
                 // Display a styled alert message (success, danger, info) in a designated area
                 displayAlert(alertAreaId, type, message, strongText = '', duration = null) {
                      const alertArea = Utils.$(`#${alertAreaId}`); if (!alertArea) { console.warn(`Alert area #${alertAreaId} not found.`); return; }
                      alertArea.innerHTML = ''; // Clear previous alerts
                      const template = Utils.$('#alert-template'); if (!template) { console.error("Alert template not found!"); return; }
                      const alertClone = template.content.cloneNode(true); const alertDiv = Utils.$('.alert', alertClone);
                      const alertIcon = Utils.$('.alert-icon', alertClone); const alertMessage = Utils.$('.alert-message', alertClone);
                      alertDiv.classList.add(`alert-${type}`); // Apply type class (e.g., alert-danger)
                      const icons = { danger: 'fa-circle-exclamation', success: 'fa-circle-check', info: 'fa-circle-info' };
                      alertIcon.classList.add(icons[type] || 'fa-circle-info'); // Set icon based on type
                      // Set message content (with optional bold text)
                      alertMessage.innerHTML = strongText ? `<strong>${Utils.sanitizeHTML(strongText)}</strong> ${Utils.sanitizeHTML(message)}` : Utils.sanitizeHTML(message);
                      alertArea.appendChild(alertClone);
                      // Use rAF to ensure the element is in the DOM before adding the 'visible' class for transition
                      requestAnimationFrame(() => { const addedAlert = Utils.$('.alert', alertArea); if (addedAlert) addedAlert.classList.add('visible'); });
                      // Auto-dismiss if duration is provided
                      if (duration && duration > 0) { setTimeout(() => { const currentAlert = Utils.$('.alert', alertArea); if (currentAlert) { currentAlert.classList.remove('visible'); currentAlert.addEventListener('transitionend', () => currentAlert.remove(), { once: true }); } }, duration); }
                  },
                 // Clear any visible alerts in a specific area
                 clearAlerts(alertAreaId) {
                     const alertArea = Utils.$(`#${alertAreaId}`);
                     if (alertArea) { const currentAlert = Utils.$('.alert.visible', alertArea); if (currentAlert) { currentAlert.classList.remove('visible'); currentAlert.addEventListener('transitionend', () => currentAlert.remove(), { once: true }); } else { alertArea.innerHTML = ''; } }
                 },
                 // Toggle loading state (spinner) on a button
                 toggleLoadingState: (buttonElement, isLoading) => { if (!buttonElement) return; buttonElement.classList.toggle('loading', isLoading); buttonElement.disabled = isLoading; },
                 // Show/hide the main calendar loader overlay
                 showCalendarLoading: (isLoading) => { if (UI.elements.calendarLoader) { UI.elements.calendarLoader.classList.toggle('hidden', !isLoading); } },
                 // Display messages specifically within the main calendar's message area
                 displayCalendarMessage: (type = '', message = '', duration = null) => {
                    // Uses the standard displayAlert logic but targets the calendar's message area
                     UI.displayAlert('calendar-message-area', type, message, '', duration);
                 },
                 // Update active state for tabs in user profile/admin sections
                 updateTabs: (menuSelector, tabSelector, activeTabId, sectionPrefix) => {
                     const menuLinks = Utils.$$(menuSelector + ' a'); const contentTabs = Utils.$$(tabSelector);
                     menuLinks.forEach(link => { link.classList.toggle('active', link.getAttribute('data-tab') === activeTabId); });
                     contentTabs.forEach(tab => {
                         const expectedId = `${sectionPrefix}-${activeTabId}-content`; const isActive = tab.id === expectedId;
                         tab.classList.toggle('active', isActive);
                         // Trigger initializations for specific tabs when they become active
                         if (isActive) {
                             switch (expectedId) {
                                 case 'profile-appointments-content': CalendarManager.initProfileCalendar(); break;
                                 case 'admin-dashboard-content': ChartManager.initAllCharts(); break; // Init charts only when dashboard is active
                                 case 'admin-bookings-content': CalendarManager.initAdminCalendar(); break;
                                 // Add cases for other tabs needing init (e.g., fetch client list)
                             }
                         }
                     });
                      console.log(`Updated tabs for ${menuSelector}, active: ${activeTabId}`);
                 },
                 // Set the profile information form fields to be editable or readonly
                 setProfileFormEditable: (isEditable) => {
                     const fields = [UI.elements.profileInfoName, UI.elements.profileInfoPhone];
                     fields.forEach(field => { if (field) { field.readOnly = !isEditable; field.style.cursor = isEditable ? 'text' : 'default'; field.style.backgroundColor = isEditable ? 'var(--soft-white)' : 'var(--light-gray)'; field.style.opacity = isEditable ? '1' : '0.7'; } });
                     UI.elements.editProfileBtn.style.display = isEditable ? 'none' : 'inline-flex';
                     UI.elements.saveProfileBtn.style.display = isEditable ? 'inline-flex' : 'none';
                      if (isEditable) UI.elements.profileInfoName.focus(); // Focus first field when editing
                      UI.clearAlerts('profile-alert-area'); // Clear alerts when toggling edit state
                 },
                 // Enable or disable the profile settings form fields and save button
                 enableProfileSettingsForm: (isEnabled) => {
                      if (!UI.elements.profileSettingsForm) return;
                      UI.elements.notificationsSelect.disabled = !isEnabled;
                      UI.elements.preferredTimeSelect.disabled = !isEnabled;
                      UI.elements.saveSettingsBtn.disabled = !isEnabled;
                      UI.clearAlerts('settings-alert-area'); // Clear alerts when toggling
                 },
                 // Fetch and display the user's booking history
                 updateBookingHistoryList: async () => {
                     const user = StateManager.getUser(); const listEl = UI.elements.bookingHistoryList; if (!user || !listEl) return;
                     listEl.innerHTML = '<li><i class="fas fa-spinner fa-spin"></i> Loading history...</li>'; // Loading state
                     // In real app, fetch history: const history = await API.getBookingHistory(user.id, user.token);
                     const allBookings = user.bookings || []; // Use current state data
                     const history = allBookings.filter(b => new Date(b.start) < new Date()) // Filter past appointments
                                         .sort((a, b) => new Date(b.start) - new Date(a.start)); // Sort descending
                     if (history.length === 0) { listEl.innerHTML = '<li>No past appointments found.</li>'; }
                     else { listEl.innerHTML = history.map(b => `<li><strong>${Utils.sanitizeHTML(b.title)}</strong><br><small>${Utils.formatDisplayDate(b.start.split('T')[0])} at ${Utils.formatDisplayTime(b.start.split('T')[1].substring(0, 5))}</small>${b.notes ? `<p style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-muted);"><em>Notes: ${Utils.sanitizeHTML(b.notes)}</em></p>` : ''}</li>`).join(''); }
                 },
                 // Fetch and display the user's favorite services
                 updateFavoritesList: async () => {
                     const user = StateManager.getUser(); const listEl = UI.elements.favoriteServicesList; if (!user || !listEl) return;
                     listEl.innerHTML = '<li><i class="fas fa-spinner fa-spin"></i> Loading favorites...</li>'; // Loading state
                     const favorites = user.preferences?.favorites || [];
                     if (favorites.length === 0) { listEl.innerHTML = '<li>You haven\'t saved any favorite services yet.</li>'; return; }
                     // Need service details (name, price) - fetch from API
                     try {
                         const services = await API.getServices();
                         listEl.innerHTML = favorites.map(favId => {
                             const service = services.find(s => s.id === favId);
                             const serviceName = service ? Utils.sanitizeHTML(service.name) : 'Unknown Service';
                             const servicePrice = service ? service.price : 'N/A';
                             return `<li data-service-id="${favId}" data-service-name="${serviceName}" data-price="${servicePrice}">
                                        <div><strong>${serviceName}</strong><br><small>Price: $${servicePrice}</small></div>
                                        <div><button class="book-btn favorite-book-btn"><i class="far fa-calendar-alt"></i> Book Now</button></div>
                                     </li>`;
                         }).join('');
                     } catch (error) {
                         console.error("Failed to load service details for favorites:", error);
                         listEl.innerHTML = '<li>Error loading favorite services.</li>';
                     }
                 },
                 // Populate a select dropdown with service options fetched from API
                 populateServiceSelect: async (selectElementId) => {
                    const selectEl = Utils.$(`#${selectElementId}`); if (!selectEl) return;
                    try { const services = await API.getServices(); selectEl.innerHTML = '<option value="" disabled selected>Select a service...</option>'; services.forEach(service => { const option = document.createElement('option'); option.value = service.id; option.textContent = `${service.name} - $${service.price}`; option.dataset.price = service.price; selectEl.appendChild(option); }); }
                    catch (error) { console.error("Failed to populate services:", error); selectEl.innerHTML = '<option value="" disabled selected>Error loading services</option>'; }
                 },
                 // Clear sensitive user data from UI elements on logout
                 clearSensitiveData: () => { CalendarManager.clearUserEvents(); if (UI.elements.profileSection) UI.updateProfileDisplay(); ChartManager.destroyAllCharts(); console.log("Sensitive UI data cleared on logout."); }
             };


            // --- CALENDAR MANAGER ---
            // Handles initialization and interaction logic for all FullCalendar instances.
            const CalendarManager = {
                 instances: { main: null, profile: null, admin: null }, // Store calendar instances
                 selectedDateElement: null, // Track visually selected date cell in main calendar
                 // Initialize the main booking calendar
                 initMainCalendar: async () => {
                     if (CalendarManager.instances.main || !UI.elements.mainCalendarEl) return; // Prevent re-init
                     if (!window.FullCalendar) { console.error("FullCalendar library not loaded!"); return; }

                     UI.showCalendarLoading(true);
                     UI.displayCalendarMessage('info', 'Loading calendar availability...');

                     try {
                         CalendarManager.instances.main = new FullCalendar.Calendar(UI.elements.mainCalendarEl, {
                             initialView: 'dayGridMonth',
                             headerToolbar: { left: 'prev', center: 'title', right: 'next' }, // Simple navigation
                             footerToolbar: { center: 'today' }, // Today button
                             dayCellDidMount: CalendarManager.handleMainDayCellMount, // Hook after day cell renders
                             dateClick: CalendarManager.handleMainDateClick,       // Hook for clicking a date
                             datesSet: CalendarManager.handleMainDatesSet,         // Hook when view changes (month/year)
                             selectable: false, // Don't allow range selection
                             showNonCurrentDates: false, // Hide days from previous/next month
                             fixedWeekCount: false, // Adjust number of weeks displayed
                             height: 'auto', // Adjust height automatically
                             eventSources: [{
                                 events: API.getMainCalendarAvailability, // Fetch background events from API
                                 display: 'background',                   // Display as background coloring
                                 classNames: (arg) => [`fc-day-${arg.event.extendedProps.status}`], // Add class based on status
                                 failure: (error) => { // Handle API fetch errors
                                    console.error("Main Calendar Availability Fetch Error:", error);
                                    UI.displayCalendarMessage('danger', 'Could not load day availability.');
                                 }
                             }],
                             loading: (isLoading) => { console.log("FC loading state:", isLoading); }, // Optional: FC's internal loading state
                             // Hook after the calendar view has been rendered
                             viewDidMount: () => {
                                 UI.showCalendarLoading(false); // Hide our custom loader
                                 // Use timeout to ensure loader is visually gone before triggering animation
                                 setTimeout(() => {
                                     UI.elements.mainCalendarEl.classList.add('loaded'); // Trigger fade-in animation
                                     UI.displayCalendarMessage(); // Clear the "Loading..." message
                                 }, 50);
                             }
                         });
                         CalendarManager.instances.main.render(); // Render the calendar
                     } catch (error) {
                         console.error("Error initializing main calendar:", error);
                         UI.showCalendarLoading(false);
                         UI.displayCalendarMessage('danger', 'Failed to initialize calendar.');
                     }
                 },
                 // Enhance day cells after they are added to the DOM (e.g., add tooltips)
                 handleMainDayCellMount(info) {
                     const el = info.el; const date = info.date;
                     const today = new Date(); today.setHours(0,0,0,0); // Compare date part only

                     // Determine date status and set appropriate tooltip
                     if (date < today) {
                         el.classList.add('fc-day-past'); // Ensure past class is added (might be redundant but safe)
                         el.title = 'Past date - unavailable';
                     } else if (el.classList.contains('fc-day-full')) {
                         el.title = 'Fully booked - unavailable';
                     } else if (el.classList.contains('fc-day-limited')) {
                         el.title = 'Limited slots - Click to book';
                     } else { // Assume available if none of the above
                         el.title = 'Available - Click to book';
                     }
                 },
                 // Handle clicks on dates in the main calendar
                 handleMainDateClick(info) {
                     // Ignore clicks on past or full days
                     if (info.dayEl.classList.contains('fc-day-past') || info.dayEl.classList.contains('fc-day-full')) {
                         UI.displayCalendarMessage('info', info.dayEl.title || 'This date is unavailable.', 3000); // Show tooltip text as message
                         return; // Do nothing more
                     }

                     // Visually select the date
                     if (CalendarManager.selectedDateElement) {
                         CalendarManager.selectedDateElement.classList.remove('selected-date'); // Deselect previous
                     }
                     info.dayEl.classList.add('selected-date'); // Select current
                     CalendarManager.selectedDateElement = info.dayEl;

                     console.log("Main Calendar Date clicked:", info.dateStr);
                     // Open the booking modal, pre-filling the selected date
                     BookingModalManager.open(null, info.dateStr); // Pass null for service ID
                     UI.displayCalendarMessage(); // Clear any previous calendar messages
                 },
                 // Handle view changes (e.g., changing month)
                 handleMainDatesSet(dateInfo) {
                     console.log('Main Calendar view changed');
                     // Clear date selection when view changes
                     if (CalendarManager.selectedDateElement) {
                         CalendarManager.selectedDateElement.classList.remove('selected-date');
                         CalendarManager.selectedDateElement = null;
                     }
                     // Note: The event source function (API.getMainCalendarAvailability) will be called automatically by FC
                 },
                 // Initialize the user's profile appointments calendar
                 initProfileCalendar: async () => {
                     const user = StateManager.getUser();
                     // Don't initialize if no user, no element, or already initialized
                     if (!user || !UI.elements.profileCalendarEl || CalendarManager.instances.profile) {
                         if(!user && UI.elements.profileCalendarEl) UI.elements.profileCalendarEl.innerHTML = '<p class="text-muted text-center">Please log in to view appointments.</p>';
                         return;
                     }
                     if (!window.FullCalendar) return;

                     UI.elements.profileCalendarEl.innerHTML = '<div class="text-center"><div class="spinner" style="margin: 2rem auto;"></div><p>Loading your appointments...</p></div>'; // Loading state

                     try {
                         const events = await API.getUserAppointments(user.id, user.token); // Fetch user's appointments
                         CalendarManager.instances.profile = new FullCalendar.Calendar(UI.elements.profileCalendarEl, {
                             initialView: 'listWeek', // List view is suitable for appointments
                              headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,listWeek' }, // View switching options
                             events: events,
                             noEventsContent: "You have no upcoming appointments.", // Message when no events
                              eventClick: (info) => { // Show details on click (simple alert for demo)
                                 alert(`Appointment: ${info.event.title}\nTime: ${info.event.start.toLocaleString()}\nNotes: ${info.event.extendedProps.notes || 'None'}`);
                              },
                             height: 'auto'
                         });
                         CalendarManager.instances.profile.render();
                         console.log("Profile calendar rendered.");
                     } catch (error) {
                          console.error("Error initializing profile calendar:", error);
                          UI.elements.profileCalendarEl.innerHTML = '<p class="text-danger text-center">Could not load appointments.</p>'; // Error state
                     }
                 },
                 // Initialize the admin calendar (shows all bookings)
                 initAdminCalendar: async () => {
                     const user = StateManager.getUser();
                     // Don't initialize if not admin, no element, or already initialized
                      if (!user || !user.isAdmin || !UI.elements.adminCalendarEl || CalendarManager.instances.admin) {
                           if((!user || !user.isAdmin) && UI.elements.adminCalendarEl) UI.elements.adminCalendarEl.innerHTML = '<p class="text-muted text-center">Admin access required.</p>';
                           return;
                      }
                      if (!window.FullCalendar) return;

                     UI.elements.adminCalendarEl.innerHTML = '<div class="text-center"><div class="spinner" style="margin: 2rem auto;"></div><p>Loading all appointments...</p></div>'; // Loading state

                     try {
                          const events = await API.getAdminAllAppointments(user.token); // Fetch all appointments
                          CalendarManager.instances.admin = new FullCalendar.Calendar(UI.elements.adminCalendarEl, {
                              initialView: 'timeGridWeek', // Weekly view is good for admin overview
                              headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek' },
                              events: events,
                              editable: true, // Allow drag & drop / resize
                              eventDrop: CalendarManager.handleAdminEventChange,   // Hook for drag & drop
                              eventResize: CalendarManager.handleAdminEventChange, // Hook for resizing
                              eventClick: (info) => { // Show details on click (simple alert)
                                 alert(`Booking Details:\nClient: ${info.event.extendedProps.clientName}\nService: ${info.event.title.split('-')[0].trim()}\nTime: ${info.event.start.toLocaleString()} - ${info.event.end?.toLocaleString() || ''}\nNotes: ${info.event.extendedProps.notes || 'None'}`);
                             },
                              slotMinTime: "08:00:00", // Salon opening hours
                              slotMaxTime: "20:00:00",
                              height: 'auto',
                              stickyHeaderDates: true // Keep day headers visible when scrolling
                          });
                          CalendarManager.instances.admin.render();
                          console.log("Admin calendar rendered.");
                     } catch (error) {
                          console.error("Error initializing admin calendar:", error);
                          UI.elements.adminCalendarEl.innerHTML = '<p class="text-danger text-center">Could not load appointments.</p>'; // Error state
                     }
                 },
                 // Handle event drag/drop or resize in the admin calendar
                 handleAdminEventChange: async (changeInfo) => {
                     const event = changeInfo.event;
                     const bookingId = event.id;
                     // Ignore changes to non-client events (like 'Team Meeting')
                      if (!event.extendedProps.userId) {
                           console.log("Ignoring change for non-client event:", event.title);
                           changeInfo.revert(); // Undo the change in the UI
                           return;
                      }

                     const newStart = event.startStr; // New start time as ISO string
                     const newEnd = event.endStr;     // New end time as ISO string (might be null)

                     console.log(`Admin Change: Event ${bookingId} moved/resized to ${newStart} - ${newEnd}`);

                     // OPTIMISTIC UPDATE: Assume success, call API, revert UI on failure
                     try {
                         const result = await API.updateAdminBooking(bookingId, newStart, newEnd, StateManager.getUser().token);
                         if (result.success) {
                              console.log("Admin booking update successful via API.");
                              // Optionally show a temporary success message
                              // UI.displayAlert('admin-calendar-message-area', 'success', 'Booking updated', '', 1500); // Needs dedicated area
                         } else {
                              console.error("API Error updating admin booking:", result.message);
                              alert(`Failed to update booking: ${result.message}`);
                              changeInfo.revert(); // Revert the UI change
                         }
                     } catch (error) {
                          console.error("Network Error updating admin booking:", error);
                          alert("Network error updating booking. Please try again.");
                          changeInfo.revert(); // Revert the UI change
                     }
                 },
                 // Refetch events for all relevant calendars (e.g., after a new booking)
                 refreshAllUserCalendars: () => {
                     if (CalendarManager.instances.profile) CalendarManager.instances.profile.refetchEvents();
                     if (CalendarManager.instances.admin) CalendarManager.instances.admin.refetchEvents();
                     // Refresh background events on main calendar too, as availability might change
                     if (CalendarManager.instances.main) CalendarManager.instances.main.refetchEvents();
                     console.log("Refreshed user-related calendars.");
                 },
                 // Destroy calendar instances on logout to clean up resources
                 clearUserEvents: () => {
                     CalendarManager.instances.profile?.destroy();
                     CalendarManager.instances.admin?.destroy();
                     CalendarManager.instances.profile = null;
                     CalendarManager.instances.admin = null;
                      // Clear the container elements
                      if(UI.elements.profileCalendarEl) UI.elements.profileCalendarEl.innerHTML = '';
                      if(UI.elements.adminCalendarEl) UI.elements.adminCalendarEl.innerHTML = '';
                 }
             };


             // --- BOOKING MODAL MANAGER ---
             // Handles the state and logic specifically for the booking modal.
             const BookingModalManager = {
                 init() {
                     // Add listeners to elements within the booking modal
                     UI.elements.bookingServiceSelect?.addEventListener('change', this.handleServiceChange);
                     UI.elements.bookingForm?.addEventListener('submit', this.handleSubmit);
                     UI.elements.timeSlotsGrid?.addEventListener('click', this.handleTimeSlotClick);
                     // Populate the service dropdown when the modal manager initializes
                     UI.populateServiceSelect('booking-service');
                 },
                 // Open the booking modal, optionally pre-filling service and/or date
                 open(serviceId = null, dateStr = null) {
                     StateManager.resetBookingModalData(); // Clear any previous data
                     UI.resetForm(UI.elements.bookingForm); // Reset form fields and errors
                     UI.clearAlerts('booking-alert-area');   // Clear any previous alerts

                     // Pre-fill fields if data is provided
                     if (serviceId) { UI.elements.bookingServiceSelect.value = serviceId; StateManager.setBookingModalData({ serviceId: serviceId }); }
                     if (dateStr) { UI.elements.bookingDateDisplay.value = Utils.formatDisplayDate(dateStr); UI.elements.bookingDateInput.value = dateStr; StateManager.setBookingModalData({ date: dateStr }); }

                     UI.updateBookingModalAccess(); // Show/hide login prompt
                     this.updateBookingButtonState(); // Enable/disable confirm button
                     this.fetchAndDisplayAvailableTimes(); // Fetch times if service/date are set
                     UI.openModal('booking-modal'); // Open the modal UI
                 },
                 // Handle change event on the service dropdown
                 handleServiceChange(event) {
                     const serviceId = event.target.value;
                     // Update state, resetting the selected time as it depends on the service
                     StateManager.setBookingModalData({ serviceId: serviceId, time: null });
                     // Fetching times is triggered automatically by the state change via StateManager listener
                 },
                 // Handle clicks on time slot buttons
                 handleTimeSlotClick(event) {
                    const target = event.target.closest('.time-slot-btn'); // Ensure click is on a button or its child
                    if (!target || target.disabled) return; // Ignore clicks on disabled slots or gaps

                     // Visually select the clicked button
                    Utils.$$('.time-slot-btn.selected', UI.elements.timeSlotsGrid).forEach(btn => btn.classList.remove('selected'));
                    target.classList.add('selected');
                    const time = target.dataset.time; // Get time from data attribute
                    // Update state with the selected time
                    StateManager.setBookingModalData({ time: time });
                    // Update hidden input (might be redundant if form submission reads from state)
                    UI.elements.bookingTimeSelectHidden.value = time;
                    // Clear any previous time selection errors
                    UI.hideError(UI.elements.bookingForm, 'booking-time');
                    // Re-evaluate confirm button state
                    BookingModalManager.updateBookingButtonState();
                 },
                 // Fetch and display available time slots based on selected service and date
                 async fetchAndDisplayAvailableTimes() {
                     const { serviceId, date } = StateManager.getBookingModalData(); // Get current selections from state
                     const grid = UI.elements.timeSlotsGrid; const loader = UI.elements.timeSlotsLoader; const noSlotsMsg = UI.elements.noSlotsMessage;

                     grid.innerHTML = ''; // Clear previous slots
                     noSlotsMsg.style.display = 'none'; // Hide "no slots" message initially

                     // Don't fetch if service or date is missing
                     if (!serviceId || !date) {
                         noSlotsMsg.textContent = 'Select service and date to see times.';
                         noSlotsMsg.style.display = 'block';
                         loader.classList.remove('visible');
                         return;
                     }

                     loader.classList.add('visible'); // Show loading spinner

                     try {
                         const result = await API.getAvailableTimes(serviceId, date); // Call API
                         if (result.success) {
                             if (result.times.length === 0) { // No slots returned
                                 noSlotsMsg.textContent = 'No available time slots found for this service on the selected date.';
                                 noSlotsMsg.style.display = 'block';
                             } else { // Populate grid with buttons for each available time
                                 result.times.forEach(time => {
                                     const button = document.createElement('button');
                                     button.type = 'button'; // Important: prevent form submission
                                     button.classList.add('time-slot-btn');
                                     button.dataset.time = time; // Store HH:MM time
                                     button.textContent = Utils.formatDisplayTime(time); // Display formatted time (e.g., 2:30 PM)
                                     grid.appendChild(button);
                                 });
                             }
                         } else {
                             throw new Error(result.message || "Failed to fetch times."); // Handle API error response
                         }
                     } catch (error) { // Handle network or other errors
                         console.error("Error fetching time slots:", error);
                         noSlotsMsg.textContent = `Error loading times: ${Utils.sanitizeHTML(error.message)}`;
                         noSlotsMsg.style.display = 'block';
                     } finally {
                         loader.classList.remove('visible'); // Hide loading spinner
                     }
                 },
                 // Enable/disable the confirm booking button based on required data and login status
                 updateBookingButtonState() {
                     const { serviceId, date, time } = StateManager.getBookingModalData();
                     const canBook = serviceId && date && time && StateManager.isLoggedIn(); // All must be true
                     UI.elements.confirmBookingBtn.disabled = !canBook;
                 },
                 // Handle the submission of the booking form
                 async handleSubmit(event) {
                     event.preventDefault(); // Prevent default form submission
                     const form = UI.elements.bookingForm;
                     const { serviceId, date, time } = StateManager.getBookingModalData();
                     const user = StateManager.getUser();
                     let isValid = true;

                     // --- Client-side Validation ---
                     UI.resetFormErrors(form);
                     UI.clearAlerts('booking-alert-area');

                     // 1. Check Login Status
                     if (!StateManager.isLoggedIn() || !user) {
                         UI.displayAlert('booking-alert-area', 'danger', 'Please log in or sign up to complete your booking.', 'Login Required');
                         return; // Stop if not logged in
                     }
                     // 2. Check required fields
                     if (!serviceId) { UI.showError(form, 'booking-service', 'Please select a service.'); isValid = false; }
                     if (!date) { UI.showError(form, 'booking-date', 'Please select a date from the calendar.'); isValid = false; }
                     if (!time) { UI.showError(form, 'booking-time', 'Please select an available time slot.'); isValid = false; }

                     if (!isValid) return; // Stop if validation fails

                     // --- Submit Booking ---
                     UI.toggleLoadingState(UI.elements.confirmBookingBtn, true); // Show loading spinner on button

                     const bookingData = {
                         serviceId: serviceId, date: date, time: time,
                         notes: UI.elements.bookingNotes.value.trim() // Include optional notes
                     };

                     try {
                         const result = await API.bookAppointment(user.id, bookingData, user.token); // Call API
                         if (result.success) {
                             // Booking successful
                             UI.displayAlert('booking-alert-area', 'success', result.message, 'Booking Confirmed!', 3000);
                             await API._delay(3100); // Wait for user to see message
                             UI.closeModal('booking-modal'); // Close modal
                             CalendarManager.refreshAllUserCalendars(); // Update calendars with new booking

                              // --- Optimistic State Update (Client-Side) ---
                              // Manually add the new booking to the user's state to avoid a full refresh.
                              const serviceOption = UI.elements.bookingServiceSelect.options[UI.elements.bookingServiceSelect.selectedIndex];
                              const serviceTitle = serviceOption ? serviceOption.text.split('-')[0].trim() : 'Appointment'; // Get service name
                              const startTime = new Date(`${date}T${time}:00`);
                              // Calculate end time based on service (using simplified logic from API mock)
                              const durationMinutes = serviceId === 'microblading' ? 90 : (serviceId === 'laser-hair' ? 60 : 60);
                              const endTime = new Date(startTime.getTime() + durationMinutes * 60000);

                              const newBookingForState = {
                                  id: result.bookingId, title: serviceTitle, start: startTime.toISOString(),
                                  end: endTime.toISOString(), serviceId: serviceId, notes: bookingData.notes
                              };
                              // Create a *new* user object incorporating the new booking array
                              const updatedUser = {
                                  ...user,
                                  bookings: [...user.bookings, newBookingForState],
                                  token: user.token // Ensure token is carried over
                              };
                              // Update local storage and application state
                              localStorage.setItem('luxeUser', JSON.stringify(updatedUser));
                              StateManager.setState('currentUser', updatedUser);
                              // --- End Optimistic State Update ---

                         } else {
                             // Booking failed (API returned success: false)
                             UI.displayAlert('booking-alert-area', 'danger', result.message || 'An unknown error occurred.', 'Booking Failed');
                             // If failure was due to conflict, reset time selection and refresh slots
                             if(result.message.toLowerCase().includes('conflict') || result.message.toLowerCase().includes('unavailable') || result.message.toLowerCase().includes('booked')) {
                                 StateManager.setBookingModalData({ time: null }); // Reset time
                                 this.fetchAndDisplayAvailableTimes(); // Refresh slots
                                 UI.showError(form, 'booking-time', 'Selected time is no longer available.');
                             }
                         }
                     } catch (error) { // Handle network or unexpected errors
                          console.error("Error submitting booking:", error);
                          UI.displayAlert('booking-alert-area', 'danger', 'A network error occurred. Please try again.', 'Submission Error');
                     } finally {
                          UI.toggleLoadingState(UI.elements.confirmBookingBtn, false); // Hide loading spinner
                          BookingModalManager.updateBookingButtonState(); // Re-check button state
                     }
                 },
                 // Show/hide the login prompt within the booking modal
                 updateBookingModalAccess: () => {
                     const isLoggedIn = StateManager.isLoggedIn();
                     UI.elements.bookingLoginPrompt.style.display = isLoggedIn ? 'none' : 'block';
                     BookingModalManager.updateBookingButtonState(); // Button state depends on login
                 }
             };


             // --- CHART MANAGER ---
             // Handles initialization and destruction of Chart.js instances.
             const ChartManager = {
                  instances: {}, // Store chart instances by ID
                  isLibLoaded: () => typeof Chart !== 'undefined', // Check if Chart.js is loaded
                  _commonOptions: { // Default options for all charts
                      responsive: true,
                      maintainAspectRatio: false,
                      plugins: { legend: { display: false } } // Hide legend by default
                  },
                   // Destroy a specific chart instance
                   destroyChart: (chartId) => {
                       if (ChartManager.instances[chartId]) {
                           ChartManager.instances[chartId].destroy();
                           delete ChartManager.instances[chartId];
                           console.log(`Chart ${chartId} destroyed.`);
                       }
                   },
                   // Destroy all currently managed chart instances
                   destroyAllCharts: () => {
                       Object.keys(ChartManager.instances).forEach(id => ChartManager.destroyChart(id));
                       console.log("All charts destroyed.");
                   },
                   // Initialize or re-initialize a chart
                   initChart: (canvas, chartId, type, data, options) => {
                       if (ChartManager.instances[chartId]) { ChartManager.destroyChart(chartId); } // Ensure old instance is gone
                       if (canvas) {
                            const ctx = canvas.getContext('2d');
                            if (ctx) {
                                // Create new chart instance
                                ChartManager.instances[chartId] = new Chart(ctx, {
                                    type: type,
                                    data: data,
                                    options: { ...ChartManager._commonOptions, ...options } // Merge common and specific options
                                });
                            } else { console.error(`Could not get 2D context for canvas element for chart: ${chartId}`); }
                       } else { console.warn(`Canvas element not found for chart: ${chartId}`); }
                   },
                   // Initialize all charts on the admin dashboard (if admin and tab is active)
                  initAllCharts: () => {
                      // Guard: Only init if admin, Chart lib loaded, and dashboard tab is active
                      if (!StateManager.isAdmin() || !ChartManager.isLibLoaded() || StateManager.getState('activeAdminTab') !== 'dashboard') {
                            ChartManager.destroyAllCharts(); // Clean up if conditions aren't met
                            return;
                      }
                      console.log("Initializing admin charts...");

                       const commonLegendOptions = { plugins: { legend: { position: 'bottom', display: true } } }; // Show legend at bottom

                       // Mock Data & Chart Initialization
                      const todayData = { labels: ['Completed', 'Upcoming', 'Cancelled'], datasets: [{ data: [Math.floor(Math.random()*10+2), Math.floor(Math.random()*10+5), Math.floor(Math.random()*3)], backgroundColor: ['var(--success-green)', 'var(--info-blue)', 'var(--error-red)'] }] };
                       ChartManager.initChart(UI.elements.todayChartCanvas, 'todayChart', 'doughnut', todayData, commonLegendOptions);

                       const revenueData = { labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'], datasets: [{ label: 'Revenue ($)', data: Array.from({length: 6}, () => Math.floor(Math.random()*2000 + 4000)), backgroundColor: 'rgba(212, 175, 55, 0.2)', borderColor: 'var(--gold-accent)', borderWidth: 2, tension: 0.4, fill: true }] };
                       ChartManager.initChart(UI.elements.revenueChartCanvas, 'revenueChart', 'line', revenueData, { scales: { y: { beginAtZero: true } } });

                       const servicesData = { labels: ['Facials', 'Microblading', 'Laser', 'Manis', 'Scrubs'], datasets: [{ label: 'Bookings', data: Array.from({length: 5}, () => Math.floor(Math.random()*30+10)), backgroundColor: 'var(--gold-accent)' }] };
                       ChartManager.initChart(UI.elements.servicesChartCanvas, 'servicesChart', 'bar', servicesData, { scales: { y: { beginAtZero: true } }, ...commonLegendOptions });

                      console.log("Admin charts initialized/updated.");
                  }
             };

            // --- PRODUCT VIEWER ---
            // Handles the 3D product rotation via drag and buttons.
            const ProductViewer = {
                 element: null, container: null, rotationY: 0, rotationX: 0, isDragging: false, startX: 0, startY: 0, currentX: 0, currentY: 0,
                 init: () => {
                     ProductViewer.container = UI.elements.product3dContainer; ProductViewer.element = UI.elements.product3d; if (!ProductViewer.container || !ProductViewer.element) return;
                     // Setup drag event listeners
                     ProductViewer.container.addEventListener('mousedown', ProductViewer.dragStart); ProductViewer.container.addEventListener('touchstart', ProductViewer.dragStart, { passive: true }); // Use passive: true for touchstart for potential scroll perf
                     document.addEventListener('mousemove', ProductViewer.dragging); document.addEventListener('touchmove', ProductViewer.dragging, { passive: false }); // Need passive: false on move to allow preventDefault
                     document.addEventListener('mouseup', ProductViewer.dragEnd); document.addEventListener('touchend', ProductViewer.dragEnd);
                 },
                 // Apply the calculated rotation to the 3D element
                 updateTransform: () => { if (ProductViewer.element) { const finalRotationY = ProductViewer.rotationY + ProductViewer.currentY; const finalRotationX = ProductViewer.rotationX - ProductViewer.currentX; ProductViewer.element.style.transform = `rotateX(${finalRotationX}deg) rotateY(${finalRotationY}deg)`; } },
                 // Start dragging: record start position, disable transition, change cursor
                 dragStart: (e) => { ProductViewer.isDragging = true; ProductViewer.startX = (e.clientX || e.touches[0].clientX); ProductViewer.startY = (e.clientY || e.touches[0].clientY); ProductViewer.element.style.transition = 'none'; ProductViewer.container.style.cursor = 'grabbing'; },
                 // While dragging: prevent default scroll, calculate rotation based on movement, update transform
                 dragging: (e) => { if (!ProductViewer.isDragging) return; e.preventDefault(); const x = (e.clientX || e.touches[0].clientX); const y = (e.clientY || e.touches[0].clientY); ProductViewer.currentY = (x - ProductViewer.startX) * 0.5; ProductViewer.currentX = (y - ProductViewer.startY) * 0.5; ProductViewer.updateTransform(); },
                 // End dragging: update permanent rotation, reset drag offsets, re-enable transition, reset cursor
                 dragEnd: () => { if (!ProductViewer.isDragging) return; ProductViewer.isDragging = false; ProductViewer.rotationY += ProductViewer.currentY; ProductViewer.rotationX -= ProductViewer.currentX; ProductViewer.currentX = 0; ProductViewer.currentY = 0; ProductViewer.element.style.transition = 'transform 0.1s linear'; ProductViewer.container.style.cursor = 'grab'; },
                 // Handle clicks on rotation control buttons
                 handleAction: (action) => { switch(action) { case 'rotate-left': ProductViewer.rotationY -= 30; break; case 'rotate-right': ProductViewer.rotationY += 30; break; case 'rotate-up': ProductViewer.rotationX += 30; break; case 'rotate-down': ProductViewer.rotationX -= 30; break; case 'reset-view': ProductViewer.rotationX = 0; ProductViewer.rotationY = 0; break; } ProductViewer.element.style.transition = 'transform 0.4s ease'; ProductViewer.updateTransform(); setTimeout(() => { if (ProductViewer.element && !ProductViewer.isDragging) { ProductViewer.element.style.transition = 'transform 0.1s linear'; } }, 400); } // Reset transition speed after button animation
            };


            // --- APPLICATION CONTROLLER ---
            // Initializes the application, sets up event listeners, and coordinates modules.
            const App = {
                init: () => {
                    console.log("Initializing LUXE Beauty App...");
                    UI.initDOMReferences(); // Cache DOM elements
                    Auth.checkLoginStatus(); // Check for existing login session
                    ProductViewer.init(); // Setup 3D product viewer
                    BookingModalManager.init(); // Setup booking modal listeners/logic
                    App.setupEventListeners(); // Attach all event listeners

                    // Set initial UI based on login state
                    UI.updateAuthNav();
                    UI.updateBookingModalAccess();
                    UI.updateProfileDisplay();
                    UI.updateFooterLinks();
                    UI.elements.copyrightYear.textContent = new Date().getFullYear(); // Set copyright year

                    // Determine initial section based on URL hash or default to 'home'
                    let initialSection = 'home';
                    if (window.location.hash) {
                        const hash = window.location.hash.substring(1);
                        if (Utils.$(`#${hash}`)) { initialSection = hash; } // Check if hash matches a section ID
                    }
                    // Set initial state *without* triggering smooth scroll (browser handles initial hash scroll)
                    StateManager._state.activeSection = initialSection; // Directly set initial state
                    UI.elements.allSections.forEach(section => { section.style.display = section.id === initialSection ? 'block' : 'none'; });
                    UI.updateActiveNavLink(); // Highlight correct nav link

                    // Initialize the main calendar after initial setup
                    CalendarManager.initMainCalendar();

                    console.log("LUXE Beauty App Initialized.");
                },
                // Centralized setup for all event listeners
                setupEventListeners: () => {
                    // Mobile Menu Toggle
                    UI.elements.burgerMenu?.addEventListener('click', UI.toggleMobileMenu);

                    // Auth Buttons
                    UI.elements.loginBtn?.addEventListener('click', () => UI.openModal('login-modal'));
                    UI.elements.signupBtn?.addEventListener('click', () => UI.openModal('signup-modal'));
                    UI.elements.logoutBtn?.addEventListener('click', Auth.logout);
                    UI.elements.adminLogoutBtn?.addEventListener('click', Auth.logout); // Admin-specific logout

                    // Close Mobile Menu on click outside
                    document.addEventListener('click', (e) => { if (UI.elements.navLinksContainer?.classList.contains('open') && !UI.elements.navLinksContainer.contains(e.target) && !UI.elements.burgerMenu.contains(e.target)) { UI.closeMobileMenu(); } });

                    // Navigation Links (Header & Footer) - Handles smooth scrolling and placeholders
                    const handleNavLinkClick = (e) => {
                        const link = e.target.closest('a'); if (!link) return; const href = link.getAttribute('href');
                        if (href && href.startsWith('#') && href.length > 1) { // Internal hash link
                            const sectionId = href.substring(1);
                            if (Utils.$(`#${sectionId}`)) { // Check if ID exists (could be section or other element)
                                 e.preventDefault(); // Prevent default jump
                                 // Only navigate via state if it's a main section managed by state
                                 if (Utils.$(`#${sectionId}.section`)) {
                                     if (StateManager.getState('activeSection') !== sectionId) { UI.navigateToSection(sectionId); }
                                 } else {
                                     // If it's not a main section, maybe scroll manually? (Optional)
                                     console.log(`Scrolling to element: #${sectionId}`);
                                     // Manual scroll logic could go here if needed for non-section anchors
                                 }
                                 if (UI.elements.navLinksContainer?.classList.contains('open')) { UI.closeMobileMenu(); }
                            }
                        } else if (href === '#') { // Placeholder link (href="#")
                           e.preventDefault(); // Prevent jump to top
                           console.log(`Placeholder link clicked: ${link.textContent.trim()} (title: ${link.title})`);
                           alert(`'${link.textContent.trim()}' feature/link is not active in this demo.`); // Inform user
                        }
                        // Allow default behavior for external links (http://...) or actual file links
                    };
                    UI.elements.navLinksContainer?.addEventListener('click', handleNavLinkClick);
                    Utils.$('footer')?.addEventListener('click', handleNavLinkClick); // Apply same logic to footer links

                    // Modal Behaviors (Close button, click outside)
                    Utils.$$('.modal').forEach(modal => { Utils.$('.close-modal', modal)?.addEventListener('click', () => UI.closeModal(modal.id)); modal.addEventListener('click', (e) => { if (e.target === modal) UI.closeModal(modal.id); }); });

                    // Modal Switching Links (Login <-> Signup)
                    Utils.$('#switch-to-signup')?.addEventListener('click', (e) => { e.preventDefault(); UI.closeModal('login-modal'); UI.openModal('signup-modal'); });
                    Utils.$('#switch-to-login')?.addEventListener('click', (e) => { e.preventDefault(); UI.closeModal('signup-modal'); UI.openModal('login-modal'); });

                    // Booking Modal Login/Signup Links
                    UI.elements.bookingLoginPrompt?.addEventListener('click', (e) => { if (e.target.classList.contains('modal-login-link')) { e.preventDefault(); UI.closeModal('booking-modal'); UI.openModal('login-modal'); } else if (e.target.classList.contains('modal-signup-link')) { e.preventDefault(); UI.closeModal('booking-modal'); UI.openModal('signup-modal'); } });

                    // Form Submissions
                    UI.elements.loginForm?.addEventListener('submit', App.handleLoginFormSubmit);
                    UI.elements.signupForm?.addEventListener('submit', App.handleSignupFormSubmit);
                    UI.elements.profileInfoForm?.addEventListener('submit', App.handleProfileInfoFormSubmit);
                    UI.elements.profileSettingsForm?.addEventListener('submit', App.handleProfileSettingsFormSubmit);
                    // Note: Booking form submit is handled within BookingModalManager.init()

                    // Signup Password Confirmation Validation
                    const signupPassword = Utils.$('#signup-password-input'); const signupConfirm = Utils.$('#signup-confirm-input');
                    if(signupPassword && signupConfirm) { signupPassword.addEventListener('input', App.validatePasswordMatch); signupConfirm.addEventListener('input', App.validatePasswordMatch); }

                    // Service Card "Book Now" Buttons (Event Delegation)
                    UI.elements.servicesGrid?.addEventListener('click', (e) => { const bookBtn = e.target.closest('.book-btn'); if (bookBtn) { const card = bookBtn.closest('.service-card'); if (card && card.dataset.serviceId) { BookingModalManager.open(card.dataset.serviceId, null); } } });

                    // Profile Edit Button
                    UI.elements.editProfileBtn?.addEventListener('click', () => UI.setProfileFormEditable(true));

                    // Profile/Admin Tab Switching (Event Delegation)
                    UI.elements.profileMenu?.addEventListener('click', (e) => App.handleTabSwitch(e, 'profile'));
                    UI.elements.adminMenu?.addEventListener('click', (e) => App.handleTabSwitch(e, 'admin'));

                    // Favorite Service "Book Now" Buttons (Event Delegation)
                    UI.elements.favoriteServicesList?.addEventListener('click', (e) => { const bookBtn = e.target.closest('.favorite-book-btn'); if (bookBtn) { const favItem = bookBtn.closest('li'); if (favItem && favItem.dataset.serviceId) { BookingModalManager.open(favItem.dataset.serviceId, null); } } });

                    // Product Viewer Controls (Event Delegation)
                    UI.elements.productControls?.addEventListener('click', (e) => { const controlBtn = e.target.closest('button'); if (controlBtn && controlBtn.dataset.action) { ProductViewer.handleAction(controlBtn.dataset.action); } });

                    // Placeholder "Shop Now" Button
                    UI.elements.shopNowBtn?.addEventListener('click', (e) => {
                        console.log("Placeholder 'Shop Now' button clicked.");
                        alert("Shopping feature is not available in this demo.");
                    });

                    // Window Resize Listener (Debounced) - Updates calendar/chart sizes
                    window.addEventListener('resize', Utils.debounce(() => { console.log("Window resized"); Object.values(CalendarManager.instances).forEach(cal => cal?.updateSize()); Object.values(ChartManager.instances).forEach(chart => chart?.resize()); UI.closeMobileMenu(); }, 250));

                    // Window Hash Change Listener (Handles browser back/forward for sections)
                    window.addEventListener('hashchange', () => { const hash = window.location.hash.substring(1); if (hash && Utils.$(`#${hash}`)) { if (StateManager.getState('activeSection') !== hash) { StateManager.setState('activeSection', hash); } } else if (!hash && StateManager.getState('activeSection') !== 'home') { StateManager.setState('activeSection', 'home'); } }); // Go home if hash removed
                },
                // --- Form Submit Handlers ---
                 handleLoginFormSubmit: async (e) => {
                     e.preventDefault(); const form = e.target; UI.resetFormErrors(form); UI.clearAlerts('login-alert-area'); const submitBtn = Utils.$('#login-submit-btn', form); UI.toggleLoadingState(submitBtn, true);
                     const email = Utils.$('#login-email-input', form).value.trim(); const password = Utils.$('#login-password-input', form).value; let isValid = true;
                     if (!email) { UI.showError(form, 'login-email', 'Email is required'); isValid = false; } else if (!Utils.isValidEmail(email)) { UI.showError(form, 'login-email', 'Invalid email format'); isValid = false; }
                     if (!password) { UI.showError(form, 'login-password', 'Password is required'); isValid = false; }
                     if (isValid) { const result = await Auth.handleLogin(email, password); if (!result.success) { UI.displayAlert('login-alert-area', 'danger', result.message || 'Login failed. Please try again.'); } }
                     UI.toggleLoadingState(submitBtn, false);
                 },
                 handleSignupFormSubmit: async (e) => {
                     e.preventDefault(); const form = e.target; UI.resetFormErrors(form); UI.clearAlerts('signup-alert-area'); const submitBtn = Utils.$('#signup-submit-btn', form);
                     const name = Utils.$('#signup-name-input', form).value.trim(); const email = Utils.$('#signup-email-input', form).value.trim(); const phone = Utils.$('#signup-phone-input', form).value.trim(); const password = Utils.$('#signup-password-input', form).value; const confirm = Utils.$('#signup-confirm-input', form).value; let isValid = true;
                     if (!name) { UI.showError(form, 'signup-name', 'Name is required'); isValid = false; } if (!email) { UI.showError(form, 'signup-email', 'Email is required'); isValid = false; } else if (!Utils.isValidEmail(email)) { UI.showError(form, 'signup-email', 'Invalid email format'); isValid = false; } if (!password) { UI.showError(form, 'signup-password', 'Password is required'); isValid = false; } else if (password.length < 8) { UI.showError(form, 'signup-password', 'Password must be at least 8 characters'); isValid = false; } if (password !== confirm) { UI.showError(form, 'signup-confirm', 'Passwords do not match'); isValid = false; }
                     if (isValid) { UI.toggleLoadingState(submitBtn, true); const result = await Auth.handleSignup(name, email, phone, password); if (!result.success) { UI.displayAlert('signup-alert-area', 'danger', result.message || 'Signup failed. Please try again.'); } UI.toggleLoadingState(submitBtn, false); }
                 },
                 handleProfileInfoFormSubmit: async (e) => {
                     e.preventDefault(); const form = e.target; const user = StateManager.getUser(); if (!user) return; UI.resetFormErrors(form); UI.clearAlerts('profile-alert-area'); const saveBtn = UI.elements.saveProfileBtn;
                     const name = UI.elements.profileInfoName.value.trim(); const phone = UI.elements.profileInfoPhone.value.trim(); let isValid = true;
                     if (!name) { UI.displayAlert('profile-alert-area','danger','Name cannot be empty.'); isValid = false; }
                     if (isValid) {
                         UI.toggleLoadingState(saveBtn, true);
                         const result = await API.updateProfile(user.id, { name, phone }, user.token);
                         if (result.success) {
                             // Update state and localStorage with the latest user data from API
                             StateManager.setState('currentUser', result.user);
                             localStorage.setItem('luxeUser', JSON.stringify(result.user)); // Update storage
                             UI.displayAlert('profile-alert-area', 'success', 'Profile updated successfully!', '', 2500);
                             UI.setProfileFormEditable(false); // Lock form again
                         } else {
                             UI.displayAlert('profile-alert-area', 'danger', result.message || 'Failed to update profile.');
                         }
                         UI.toggleLoadingState(saveBtn, false);
                      }
                 },
                handleProfileSettingsFormSubmit: async (e) => {
                     e.preventDefault(); const form = e.target; const user = StateManager.getUser(); if (!user) return; UI.resetFormErrors(form); UI.clearAlerts('settings-alert-area'); const saveBtn = UI.elements.saveSettingsBtn;
                     const notifications = UI.elements.notificationsSelect.value; const preferredTime = UI.elements.preferredTimeSelect.value; UI.toggleLoadingState(saveBtn, true);
                     try {
                         const result = await API.updatePreferences(user.id, { notifications, preferredTime }, user.token);
                         if (result.success) {
                             // Update state and localStorage with latest user data
                             StateManager.setState('currentUser', result.user);
                             localStorage.setItem('luxeUser', JSON.stringify(result.user));
                             UI.displayAlert('settings-alert-area', 'success', 'Settings saved successfully!', '', 2500);
                         } else {
                             UI.displayAlert('settings-alert-area', 'danger', result.message || 'Failed to save settings.');
                         }
                     } catch (error) {
                          console.error("Settings save error:", error);
                          UI.displayAlert('settings-alert-area', 'danger', 'A network error occurred.');
                     } finally {
                          UI.toggleLoadingState(saveBtn, false);
                     }
                 },
                // --- Other Event Handlers ---
                // Validate password confirmation field on input
                validatePasswordMatch: () => {
                     const password = Utils.$('#signup-password-input')?.value; const confirm = Utils.$('#signup-confirm-input')?.value; const form = UI.elements.signupForm;
                     // Only show error if confirm has been touched and doesn't match
                     if (confirm && password !== confirm) { UI.showError(form, 'signup-confirm', 'Passwords do not match'); }
                     else if (confirm) { UI.hideError(form, 'signup-confirm'); } // Hide error if they now match (and confirm has value)
                 },
                 // Handle clicks within profile/admin side menus for tab switching
                 handleTabSwitch: (e, sectionPrefix) => { const link = e.target.closest('a'); if (link && link.dataset.tab) { e.preventDefault(); const tabId = link.dataset.tab; const stateKey = sectionPrefix === 'profile' ? 'activeProfileTab' : 'activeAdminTab'; StateManager.setState(stateKey, tabId); } },
            };

            // --- Initialize the Application ---
            // Waits for the DOM to be fully loaded before running the initialization logic.
            document.addEventListener('DOMContentLoaded', App.init);

        })();
    </script>

</body>
</html>can you rewrite the whole codeand improve design calendar and do it more sophisticated do it more and more sophisticated
